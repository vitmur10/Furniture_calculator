{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

<div class="container py-5">
  <h3 class="fw-bold text-center mb-4">üìä –ó–≤—ñ—Ç –≤–∏—Ä–æ–±—ñ—Ç–∫—É –∑–∞ –ø–µ—Ä—ñ–æ–¥</h3>

  <!-- üîπ –§–æ—Ä–º–∞ –≤–∏–±–æ—Ä—É –ø–µ—Ä—ñ–æ–¥—É -->
  <form method="get" class="card p-3 shadow-sm mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label fw-bold">–ó –¥–∞—Ç–∏</label>
        <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold">–ü–æ –¥–∞—Ç—É</label>
        <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
      </div>
      <div class="col-md-4 text-end mt-3 d-flex justify-content-end gap-2">
        <button type="submit" class="btn btn-primary px-4">
          üîç –ü–æ–∫–∞–∑–∞—Ç–∏
        </button>

        {% if table %}
          <button type="submit"
                  name="export"
                  value="pdf"
                  class="btn btn-outline-secondary px-4">
            ‚¨áÔ∏è PDF
          </button>
        {% endif %}
      </div>
    </div>
  </form>

  {% if table %}
  <!-- üîπ –¢–∞–±–ª–∏—Ü—è –∑–≤—ñ—Ç—É -->
  <div class="table-responsive card shadow-sm">
    <table class="table table-bordered table-striped text-center align-middle mb-0">
      <thead class="table-primary">
        <tr>
          <th rowspan="2" class="align-middle">–î–∞—Ç–∞</th>
          <th colspan="{{ orders|length }}">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (% –≤–∏–∫–æ–Ω–∞–Ω–Ω—è)</th>
          <th colspan="{{ workers|length }}">–ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏ (–≥–æ–¥)</th>
          <th rowspan="2" class="align-middle">Œ£ –≥–æ–¥ –∑–∞ –¥–µ–Ω—å</th>
        </tr>
        <tr>
          {% for o in orders %}
            <th>
              <div>‚Ññ{{ o.number }}</div>
              <div class="small text-muted">{{ o.name }}</div>
            </th>
          {% endfor %}

          {# ‚úÖ –¢–µ–ø–µ—Ä workers = [{"id":..., "name":...}] #}
          {% for w in workers %}
            <th>{{ w.name }}</th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>
        {% for row in table %}
        <tr>
          <td class="fw-bold">{{ row.date|date:"d.m" }}</td>

          {# –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: % –Ω–∞ —Ü—é –¥–∞—Ç—É #}
          {% for o in orders %}
            <td>{{ row|get_item:o.number|floatformat:1 }}</td>
          {% endfor %}

          {# ‚úÖ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏: –≥–æ–¥–∏–Ω–∏ –ø–æ worker_id #}
          {% for w in workers %}
            <td>{{ row|get_item:w.id|floatformat:1 }}</td>
          {% endfor %}

          <td class="fw-bold bg-light">{{ row.total|floatformat:1 }}</td>
        </tr>
        {% endfor %}

        <!-- üîπ –ü—ñ–¥—Å—É–º–∫–æ–≤–∏–π —Ä—è–¥–æ–∫ -->
        <tr class="table-secondary fw-bold">
          <td>Œ£ –∑–∞ –ø–µ—Ä—ñ–æ–¥</td>

          {# –ø–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö ‚Äî –æ—Å—Ç–∞–Ω–Ω—ñ–π % –≤–∏–∫–æ–Ω–∞–Ω–Ω—è #}
          {% for o in orders %}
            <td>{{ totals_orders|get_item:o.number|floatformat:1 }}%</td>
          {% endfor %}

          {# ‚úÖ –ø–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞—Ö ‚Äî —Å—É–º–∞—Ä–Ω—ñ –≥–æ–¥–∏–Ω–∏ –ø–æ worker_id #}
          {% for w in workers %}
            <td>{{ totals_workers|get_item:w.id|floatformat:1 }}</td>
          {% endfor %}

          <td>{{ total_all|floatformat:1 }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- üîπ –ü—ñ–¥—Å—É–º–∫–æ–≤—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –ø–æ –≥–æ–¥–∏–Ω–∞—Ö (–Ω–æ—Ä–º–∞) -->
  <!-- üîπ –ü—ñ–¥—Å—É–º–∫–æ–≤—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ –ø–æ –º–µ—Ç–æ–¥–∏—á—Ü—ñ –∑–∞–º–æ–≤–Ω–∏–∫–∞ -->
  <div class="mt-4">
    <h5 class="fw-bold">üìà –ü—ñ–¥—Å—É–º–∫–æ–≤—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ (–ø–æ –º–µ—Ç–æ–¥–∏—á—Ü—ñ):</h5>
    <ul class="list-group shadow-sm">
      <li class="list-group-item">
        –ü–µ—Ä—ñ–æ–¥:
        <strong>{{ start_date|date:"d.m.Y" }} ‚Äì {{ end_date|date:"d.m.Y" }}</strong>
        ({{ work_days }} –¥–Ω—ñ–≤)
      </li>

      <li class="list-group-item">
        –í—Å—å–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–æ –∑–∞ –ø–µ—Ä—ñ–æ–¥ (V–∑–∞–≥):
        <strong>{{ vzag|floatformat:2 }} –∫/—Å</strong>
      </li>

      <li class="list-group-item">
        –ù–æ—Ä–º–∞ –≤–∏—Ä–æ–±—ñ—Ç–∫—É (Hv):
        <strong>{{ hv|floatformat:2 }} –∫/—Å/–≥–æ–¥</strong>
      </li>

      <li class="list-group-item">
        –ù–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–π —á–∞—Å (T–Ω–æ—Ä–º–∞ = V–∑–∞–≥ / Hv):
        <strong>{{ t_norma|floatformat:1 }} –≥–æ–¥</strong>
      </li>

      <li class="list-group-item">
        –§–∞–∫—Ç–∏—á–Ω–∏–π —á–∞—Å (T—Ñ–∞–∫—Ç):
        <strong>{{ t_fact|floatformat:1 }} –≥–æ–¥</strong>
      </li>

      <li class="list-group-item">
        –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (E = T–Ω–æ—Ä–º–∞ / T—Ñ–∞–∫—Ç √ó 100%):
        <strong class="{% if eff_percent >= 100 %}text-success{% else %}text-danger{% endif %}">
          {{ eff_percent|floatformat:1 }}%
        </strong>
      </li>
    </ul>
  </div>

  {% else %}
  <div class="alert alert-info text-center mt-4">
    –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥
  </div>
  {% endif %}
</div>

{% endblock %}
