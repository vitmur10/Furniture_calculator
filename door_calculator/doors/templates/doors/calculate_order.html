{% extends 'base.html' %}
{% block content %}
<style>
    .ks-tooltip {
      position: relative;
      cursor: help;
      border-bottom: 1px dashed #0d6efd;
    }
    .custom-col {
  flex: 0 0 20.833%; /* 2.5 / 12 ‚âà 0.2083 ‚Üí 20.83% —à–∏—Ä–∏–Ω–∏ */
  max-width: 20.833%;
}
    #sketch-section{
      flex: 0 0 420px;   /* —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ */
      width: 420px;
      min-width: 420px;
      max-width: 420px;
    }

    /* 4) –Ø–∫—â–æ embed/preview –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ª—ñ–≤–æ—ó ‚Äî –π–æ–º—É —Ç–µ–∂ min-width:0, —â–æ–± –Ω–µ –ª–∞–º–∞–≤ flex */
    #pdfPreviewBox{
      min-width: 0;
    }

    /* 5) –í–ê–ñ–õ–ò–í–û: –ù–ï —Ö–æ–≤–∞—î–º–æ —Å–∞–º #sketch-section –Ω—ñ—è–∫–∏–º–∏ collapsed —Å—Ç–∏–ª—è–º–∏ */
    #sketch-section.collapsed{
      display: block !important;
      width: 420px !important;
      min-width: 420px !important;
      max-width: 420px !important;
    }
    .ks-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 130%;
      left: 50%;
      transform: translateX(-50%);
      white-space: pre;
      background: rgba(0, 0, 0, 0.92);
      color: #fff;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.45;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      min-width: 320px;
      text-align: left;
      z-index: 999;
    }

    .ks-tooltip::before {
      content: "";
      position: absolute;
      bottom: 115%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.92);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .ks-tooltip:hover::after,
    .ks-tooltip:hover::before {
      opacity: 1;
    }

  .products-columns {
    column-count: 2;
    column-gap: 24px;
  }

  .addons-columns {
    column-count: 2;
    column-gap: 24px;
  }

  .products-columns > *,
  .addons-columns > * {
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
  }

  @media (max-width: 768px) {
    .products-columns,
    .addons-columns {
      column-count: 1;
    }
  }
  .order-layout {
    display: flex;
    flex-wrap: nowrap;
    height: auto;
    min-height: calc(100vh - 120px);
    overflow: visible;
    transition: all 0.4s ease;
    align-items: flex-start;
    gap: 16px;
  }

  .order-sketch {
    flex: 0 0 420px;
    max-width: 420px;
    background: transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    border-right: 3px solid #0d6efd22;
    position: sticky;          /* üî• —Ä–æ–±–∏–º–æ –∫–æ–ª–æ–Ω–∫—É ¬´–ª–∏–ø–∫–æ—é¬ª */
    top: 80px;                 /* –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç—Ü—ñ */
    align-self: flex-start;    /* —â–æ–± sticky –ø—Ä–∞—Ü—é–≤–∞–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ flex */
    transition: all 0.4s ease;
    padding: 20px;
    box-sizing: border-box;
    overflow: hidden;
  }
.main-image-wrapper {
    position: relative;
}
  .order-sketch.dragging {
    cursor: grabbing;
  }

  .main-image-wrapper {
    width: 100%;
    height: 380px;
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.3);
    overflow: hidden;
    position: relative;
    background: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
  }

  .main-image-inner {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transform-origin: center center;
    transition: transform 0.05s linear;
  }

  .main-image-inner img {
    width: 100%;
    height: auto;
    max-height: 100%;
    object-fit: contain;
    user-select: none;
    pointer-events: auto;
  }

  .marker-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .marker-dot {
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid red;
    background: rgba(255,0,0,0.25);
    transform: translate(-50%, -50%);
  }

  .marker-dot::after {
    content: attr(data-label);
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: #fff;
    background: rgba(0,0,0,0.6);
    padding: 1px 4px;
    border-radius: 4px;
    white-space: nowrap;
  }

  .zoom-hint {
    position: absolute;
    right: 10px;
    bottom: 10px;
    font-size: 12px;
    padding: 5px 9px;
    background: rgba(255,255,255,.9);
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,.08);
    z-index: 5;
  }

  .thumbs-row {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    max-height: 110px;
    overflow-y: auto;
  }

  .thumbs-row img {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.1s, border-color 0.1s;
  }

  .thumbs-row img.active {
    border-color: #0d6efd;
  }

  .thumbs-row img:hover {
    transform: scale(1.05);
  }

  .toggle-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.85);
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    z-index: 10;
    transition: all 0.25s ease;
  }
  .toggle-btn:hover {
    background: #0d6efd;
    color: #fff;
  }

  #restoreSketch {
    display: none;
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 1000;
    background: #0d6efd;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }
  #restoreSketch:hover { background: #0b5ed7; }

  .order-form {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    background: var(--card-bg);
  }

  .product-option {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: .75rem;
    background: var(--card-bg);
    border-radius: 8px;
    padding: 6px 10px;
    transition: background 0.25s ease;
  }
  .product-option:hover { background: rgba(13, 110, 253, 0.05); }

  .product-option img {
    width: 45px;
    height: 45px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #ccc;
    transition: transform 0.2s ease;
  }
  .product-option img:hover { transform: scale(1.05); }

  .summary-table img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .summary-table th {
    background-color: #0d6efd;
    color: #fff;
  }

  .total-box {
    font-size: 1.3rem;
    font-weight: bold;
    text-align: center;
    background: #d1e7dd;
    color: #51aa16;
    padding: 0.8rem;
    border-radius: 12px;
    margin-top: 1.2rem;
  }

  .final-form {
    display: none;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  .final-form.visible {
    display: block;
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .category-card { background: #fff; }
  .category-card h6 { margin-bottom: .5rem; }

  .floating-upload {
    margin-top: 12px;
    width: 100%;
  }

  /* üîΩ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π */
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .category-toggle-btn {
    border: none;
    background: transparent;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: #0d6efd;
  }

  .category-toggle-btn .icon {
    display: inline-block;
    transition: transform 0.2s ease;
  }

  .category-body.collapsed {
    display: none;
  }

  .category-toggle-btn.collapsed .icon {
    transform: rotate(-90deg);
  }

  @media (max-width: 991px) {
    .order-layout { flex-direction: column; height: auto; }
    .order-sketch {
      flex: none;
      max-width: 100%;
      width: 100%;
      border-right: none;
      border-bottom: 3px solid #0d6efd22;
      position: static;  /* –Ω–∞ –º–æ–±—ñ–ª—Ü—ñ –∑–∞–±–∏—Ä–∞—î–º–æ sticky, —â–æ–± –Ω–µ –ª–∞–º–∞–ª–æ –≤–µ—Ä—Å—Ç–∫—É */
      top: auto;
    }
  }
</style>

<button id="restoreSketch">üìà –ü–æ–∫–∞–∑–∞—Ç–∏ –µ—Å–∫—ñ–∑</button>

<div class="order-layout">

{# ‚úÖ –õ–Ü–í–ê –ß–ê–°–¢–ò–ù–ê: –µ—Å–∫—ñ–∑ + —Ñ–∞–π–ª–∏ (—Ö–æ–≤–∞—î—Ç—å—Å—è), PDF preview –ù–ï —Ö–æ–≤–∞—î—Ç—å—Å—è #}

<div class="order-sketch" id="sketch-section">

  <div class="d-flex align-items-center gap-2 mb-2">
    <button class="toggle-btn" id="toggleSketch" type="button">üìâ –ó–≥–æ—Ä–Ω—É—Ç–∏</button>
    <button class="toggle-btn" id="restoreSketch" type="button" style="display:none;">üìà –ü–æ–∫–∞–∑–∞—Ç–∏</button>
  </div>

  {# ‚úÖ –•–û–í–ê–Ñ–ú–û –¢–Ü–õ–¨–ö–ò –¶–ï: —Ñ–æ—Ç–æ # + # —Ñ–∞–π–ª–∏ #}
  <div id="sketchHidePart">

    {% if order.images.exists %}
      {% with first_img=order.images.all.0 %}
        <div class="main-image-wrapper" id="mainImageWrapper">
          <div class="main-image-inner" id="mainImageInner">

            {% if first_img.image %}
              <img
                src="{{ first_img.image.url }}"
                alt="–ï—Å–∫—ñ–∑ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
                id="mainImage"
                data-image-id="{{ first_img.id }}"
              >
            {% else %}
              <img
                src="{% url 'm365_image_content' first_img.id %}"
                alt="–ï—Å–∫—ñ–∑ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
                id="mainImage"
                data-image-id="{{ first_img.id }}"
              >
            {% endif %}

            <div class="marker-layer" id="markerLayer"></div>
          </div>

          <div class="zoom-hint">
            –ö–æ–ª—ñ—â–∞—Ç–∫–æ ‚Äî –∑—É–º, –º–∏—à–∫–æ—é ‚Äî –ø–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏
          </div>
        </div>

        <a href="{% url 'annotate_order_image' first_img.id %}"
           class="btn btn-outline-secondary btn-sm w-100 mt-2"
           id="annotateBtn">
          üñäÔ∏è –†–æ–∑–º—ñ—Ç–∏—Ç–∏ —Ñ–æ—Ç–æ
        </a>

        <div class="thumbs-row mt-2">
          {% for img in order.images.all %}
            {% if img.image %}
              <img
                src="{{ img.image.url }}"
                class="thumb-img {% if forloop.first %}active{% endif %}"
                data-full="{{ img.image.url }}"
                data-image-id="{{ img.id }}"
              >
            {% else %}
              <img
                src="{% url 'm365_image_thumb' img.id %}"
                class="thumb-img {% if forloop.first %}active{% endif %}"
                data-full="{% url 'm365_image_content' img.id %}"
                data-image-id="{{ img.id }}"
              >
            {% endif %}
          {% endfor %}
        </div>
      {% endwith %}
    {% else %}
      <div class="text-muted small mb-2">–§–æ—Ç–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ</div>
    {% endif %}

    {% if order.files.all %}
      <div class="mt-3 w-100">
        <h6 class="fw-bold mb-2">–ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏:</h6>

        <ul class="list-unstyled small" id="filesList">
          {% for f in order.files.all %}
            <li class="mb-2 d-flex align-items-center gap-2">
              <div class="flex-grow-1">
                {% if f.source == "m365" %}
                  {{ f.remote_name|default:f.description }}
                {% else %}
                  {{ f.description }}
                {% endif %}
              </div>

              {% if f.source == "m365" %}
                <button type="button"
                        class="btn btn-sm btn-outline-secondary js-preview"
                        data-preview-url="{% url 'order_file_inline' f.id %}">
                  üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–¥
                </button>
              {% elif f.file %}
                <button type="button"
                        class="btn btn-sm btn-outline-secondary js-preview"
                        data-preview-url="{{ f.file.url }}">
                  üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–¥
                </button>
              {% endif %}

              {% if f.source == "m365" %}
                <a class="btn btn-sm btn-outline-primary"
                   href="{% url 'order_file_download' f.id %}">
                  –°–∫–∞—á–∞—Ç–∏
                </a>
                {% if f.remote_web_url %}
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ f.remote_web_url }}" target="_blank">
                    –í—ñ–¥–∫—Ä–∏—Ç–∏
                  </a>
                {% endif %}
              {% elif f.file %}
                <a class="btn btn-sm btn-outline-primary" href="{{ f.file.url }}" download>
                  –°–∫–∞—á–∞—Ç–∏
                </a>
                <a class="btn btn-sm btn-outline-secondary" href="{{ f.file.url }}" target="_blank">
                  –í—ñ–¥–∫—Ä–∏—Ç–∏
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

  </div>
  {# ‚úÖ /sketchHidePart #}

  {# ‚úÖ –ü–ï–†–ï–ì–õ–Ø–î –§–ê–ô–õ–£ –ù–ï –•–û–í–ê–Ñ–¢–¨–°–Ø (–ø–æ–∑–∞ sketchHidePart —ñ –ø–æ–∑–∞ if order.files.all) #}
  <div id="pdfPreviewBox" class="mt-3" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold">–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–∞–π–ª—É</div>
      <button type="button" id="closePreview" class="btn btn-sm btn-outline-secondary">‚úñ</button>
    </div>

    <div class="file-preview" style="height: 600px;">
      <embed id="pdfEmbed" src="" type="application/pdf" width="100%" height="100%" />
    </div>
  </div>

</div>
  <!-- üîπ –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
    {% if request.user.is_superuser %}

  <div class="order-form">
    <h4 class="fw-bold mb-2">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ{{ order.order_number }}</h4>
    <p class="text-muted mb-4">–í–∞—Ä—Ç—ñ—Å—Ç—å 1 –∫/—Å: <strong>{{ rate }} –≥—Ä–Ω</strong></p>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary btn-sm" id="viewByCategories">
          üóÇÔ∏è –ü–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="viewFlatList">
          üìÑ –ü–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
        </button>
      </div>
    </div>

    <!-- üîπ –ë–ª–æ–∫ –¥–∞–Ω–∏—Ö –∑–∞–º–æ–≤–Ω–∏–∫–∞ -->
    <div class="mb-4 border rounded p-3 bg-white">
      <form method="post" class="row g-2 align-items-end" id="customerForm">
        {% csrf_token %}
        <input type="hidden" name="assign_customer" value="1">

        <div class="col-12">
          <label class="form-label fw-bold mb-1">–ó–∞–º–æ–≤–Ω–∏–∫</label>
          <select name="existing_customer" id="existingCustomerSelect" class="form-select">
            <option value="">‚Äî –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ ‚Äî</option>
            {% for c in customers %}
            <option value="{{ c.id }}" {% if order.customer and c.id == order.customer.id %}selected{% endif %}>
              {{ c.name }}{% if c.phone %} ‚Äî {{ c.phone }}{% endif %}
            </option>
            {% endfor %}
          </select>
        </div>

        <div id="newCustomerFields" class="row g-3 mt-1"
             {% if order.customer %}style="display:none"{% endif %}>
          <div class="col-md-6">
            <label class="form-label small">–Ü–º º—è / –ö–æ–º–ø–∞–Ω—ñ—è</label>
            <input type="text"
                   name="customer_name"
                   class="form-control form-control-sm"
                   placeholder="–ù–∞–ø—Ä.: –Ü–≤–∞–Ω –∞–±–æ –¢–û–í –ë—É–¥–ú–æ–Ω—Ç–∞–∂"
                   value="{% if order.customer %}{{ order.customer.name }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="text"
                   name="customer_phone"
                   class="form-control form-control-sm"
                   placeholder="+38 (0__) ___ __ __"
                   value="{% if order.customer and order.customer.phone %}{{ order.customer.phone }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">Email</label>
            <input type="email"
                   name="customer_email"
                   class="form-control form-control-sm"
                   placeholder="example@gmail.com"
                   value="{% if order.customer and order.customer.email %}{{ order.customer.email }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
            <input type="text"
                   name="customer_address"
                   class="form-control form-control-sm"
                   placeholder="–ú—ñ—Å—Ç–æ, –≤—É–ª–∏—Ü—è, –±—É–¥–∏–Ω–æ–∫"
                   value="{% if order.customer and order.customer.address %}{{ order.customer.address }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">–Ñ–î–†–ü–û–£ / –Ü–ü–ù</label>
            <input type="text"
                   name="customer_company_code"
                   class="form-control form-control-sm"
                   placeholder="–¢—ñ–ª—å–∫–∏ –¥–ª—è —é—Ä. –æ—Å—ñ–±"
                   value="{% if order.customer and order.customer.company_code %}{{ order.customer.company_code }}{% endif %}">
          </div>
        </div>

        <div id="saveNewCustomerBtn" class="mt-3"
             {% if order.customer %}style="display:none"{% endif %}>
          <button class="btn btn-success btn-sm w-100">
            üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–º–æ–≤–Ω–∏–∫–∞
          </button>
        </div>
      </form>
    </div>
    <div class="mb-3">
      <label class="form-label fw-bold">–ù–∞–∑–≤–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
    <br>
        {% if order.order_name %}
          {{ order.order_name }}
        {% else %}
          <span class="text-muted">‚Äî</span>
        {% endif %}
    </div>

    <form method="post">
      {% csrf_token %}
        <div class="mb-3">
          <label class="form-label fw-bold">–ù–∞–∑–≤–∞ / –Ω–æ–º–µ—Ä –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó</label>

          <div class="d-flex gap-2">
            <!-- –°—é–¥–∏ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—Ç–∏–º–µ–º–æ –Ω–æ–º–µ—Ä + –Ω–∞–∑–≤—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó -->
            <input type="text"
                   name="name"
                   id="positionNameInput"
                   class="form-control"
                   placeholder="–ù–∞–ø—Ä.: 1. –ú—ñ–∂–∫—ñ–º–Ω–∞—Ç–Ω—ñ –¥–≤–µ—Ä—ñ (–∞–≤—Ç–æ –∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó)"
                   required>

            <!-- –î—Ä–æ–ø–¥–∞—É–Ω –∑ –Ω–æ–º–µ—Ä–∞–º–∏, —è–∫—ñ –º–æ–∂–Ω–∞ –∫–ª—ñ–∫–∞—Ç–∏ –º–∏—à–∫–æ—é -->
            <select id="positionNumberSelect"
                    class="form-select"
                    style="max-width: 110px;">
              <option value="">‚Ññ</option>
            </select>
          </div>

          <div class="form-text small text-muted">
            –ú–æ–∂–Ω–∞ –≤–ø–∏—Å–∞—Ç–∏ —Å–≤–æ—é –Ω–∞–∑–≤—É, –∞ –º–æ–∂–Ω–∞ –ø—Ä–æ—Å—Ç–æ –≤–∏–±—Ä–∞—Ç–∏ –Ω–æ–º–µ—Ä ‚Äî —ñ –ø–æ–ª–µ –∑–∞–ø–æ–≤–Ω–∏—Ç—å—Å—è "–Ω–æ–º–µ—Ä + –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –ø–µ—Ä—à–æ–≥–æ –≤–∏–±—Ä–∞–Ω–æ–≥–æ –≤–∏—Ä–æ–±—É".
          </div>
        </div>

      {% if categories %}
      <div class="mb-3" id="productsByCategories"  class="products-columns" style="display:none;">
        <label class="form-label fw-bold">–û–±–µ—Ä—ñ—Ç—å –≤–∏—Ä–æ–±–∏ (–ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö):</label>
        {% for cat in categories %}
          <div class="category-card border rounded p-3 mb-3">
            <div class="category-header"
                 data-target="cat-body-{{ cat.id }}">
              <h6 class="fw-bold mb-0">üì¶ {{ cat.name }}</h6>
              <button type="button"
                      class="category-toggle-btn btn btn-sm p-0"
                      data-target="cat-body-{{ cat.id }}">
                <span class="icon">‚ñæ</span>
                <span class="text">–ó–≥–æ—Ä–Ω—É—Ç–∏</span>
              </button>
            </div>

            <div id="cat-body-{{ cat.id }}" class="category-body mt-2">
              {% for p in cat.products.all %}
                <div class="product-option d-flex align-items-center gap-2">
                    <input type="checkbox"
                           name="products"
                           value="{{ p.id }}"
                           class="form-check-input product-check"
                           data-category="{{ cat.name }}"
                           data-prod-id="{{ p.id }}">

                    {% if p.image %}
                      <img src="{{ p.image.url }}" alt="{{ p.name }}">
                    {% else %}
                      <img src="https://via.placeholder.com/50x50?text=No+Img" alt="{{ p.name }}">
                    {% endif %}

                    <label class="flex-grow-1 mb-0">{{ p.name }} ({{ p.base_ks }} –∫/—Å)</label>

                    <input type="number"
                           min="1"
                           value="1"
                           class="form-control form-control-sm prod-qty"
                           style="width: 90px;"
                           name="prod_qty_{{ p.id }}">
                  </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
      {% endif %}

      <div id="productsFlatList" class="products-columns">
        <label class="form-label fw-bold">–û–±–µ—Ä—ñ—Ç—å –≤–∏—Ä–æ–±–∏:</label>
        {% for p in products %}
          <div class="product-option d-flex align-items-center gap-2">
            <input type="checkbox"
                   name="products"
                   value="{{ p.id }}"
                   class="form-check-input product-check"
                   data-category="{{ p.category.name }}"
                   data-prod-id="{{ p.id }}">

            {% if p.image %}
              <img src="{{ p.image.url }}" alt="{{ p.name }}">
            {% else %}
              <img src="https://via.placeholder.com/50x50?text=No+Img" alt="{{ p.name }}">
            {% endif %}

            <label class="flex-grow-1 mb-0">{{ p.name }} ({{ p.base_ks }} –∫/—Å)</label>

            <!-- ‚úÖ –∫-—Å—Ç—å –≤–∏—Ä–æ–±—ñ–≤ -->
            <input type="number"
                   min="1"
                   value="1"
                   class="form-control form-control-sm prod-qty"
                   style="width: 90px;"
                   name="prod_qty_{{ p.id }}"
                   disabled>
          </div>
        {% endfor %}
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π:</label>
        <input type="number" name="item_qty" min="1" value="1" class="form-control" required>
      </div>

      <div class="mb-3 addons-columns">
        <label class="form-label fw-bold">–î–æ–ø–æ–≤–Ω–µ–Ω–Ω—è (–∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é):</label>
        {% for a in addons %}
        <div class="input-group mb-2 ">
          <div class="input-group-text">
            <input type="checkbox" name="additions" value="{{ a.id }}" class="form-check-input mt-0">
          </div>
          <span class="input-group-text w-50">{{ a.name }}</span>
          <input type="number" name="add_qty_{{ a.id }}" min="1" value="1" class="form-control">
          <span class="input-group-text">{{ a.ks_value }} –∫/—Å</span>
        </div>
        {% endfor %}
      </div>

  <!--    <div class="mb-3">
        <label class="form-label fw-bold">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏:</label>
        {% for c in coefficients %}
        <div class="form-check form-check-inline mb-2">
          <input type="checkbox" name="coefficients" value="{{ c.id }}" class="form-check-input">
          <label class="form-check-label">{{ c.name }} √ó{{ c.value }}</label>
        </div>
        {% endfor %}
      </div>-->

      <div class="text-center mb-4">
        <button type="submit" class="btn btn-danger w-100 py-2">‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é</button>
      </div>
    </form>
      {% endif %}
<div class="row g-2 mb-2">

  <!-- –ù–∞—Ü—ñ–Ω–∫–∞ -->
  <div class="col-md-2 custom-col"> <!-- –ë—É–ª–æ col-md-4 -->
    <form id="saveMarkupForm" method="post" class="card p-2 h-100">
      {% csrf_token %}
      <input type="hidden" name="save_markup" value="1">

      <label class="form-label fw-bold mb-1">–ù–∞—Ü—ñ–Ω–∫–∞ (%)</label>
      <div class="input-group">
        <input type="number" step="0.01"
               name="order_markup"
               value="{{ order.markup_percent|default:0 }}"
               class="form-control"
               placeholder="–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º">
        <button type="submit" class="btn btn-primary">üíæ</button>
      </div>
      <small class="text-muted">Fallback –¥–ª—è –ø–æ—Ä–æ–∂–Ω—ñ—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π</small>
    </form>
  </div>

  <!-- –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ -->
  <div class="col-md-9"> <!-- –ë—É–ª–æ col-md-8 -->
    <form id="bulkCoeffsForm" method="post" class="card p-2 mb-2">
      {% csrf_token %}
      <input type="hidden" name="bulk_coefficients" value="1">

      <div class="row g-2 align-items-stretch">
        <!-- –õ–Ü–í–û: –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ (—à–∏—Ä–æ–∫–æ) -->
        <div class="col-md-9">
          <label class="form-label fw-bold mb-1">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏</label>
          <select name="bulk_coeff_ids" class="form-select" multiple size="3">
            {% for c in coefficients %}
              <option value="{{ c.id }}">{{ c.name }} +{{ c.value }}</option>
            {% endfor %}
          </select>
          <small class="text-muted">Ctrl / Shift ‚Äî –º—É–ª—å—Ç–∏–≤–∏–±—ñ—Ä</small>
        </div>

        <!-- –ü–†–ê–í–û: –∫–µ—Ä—É–≤–∞–Ω–Ω—è (–≤ –∫–æ–ª–æ–Ω–∫—É) -->
        <div class="col-md-3 d-flex flex-column gap-2">
          <div>
            <label class="form-label fw-bold mb-1">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</label>
            <select name="bulk_scope" class="form-select">
              <option value="all">–í—Å—ñ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º</option>
              <option value="selected">–õ–∏—à–µ –≤–∏–±—Ä–∞–Ω–∏–º</option>
            </select>
          </div>

          <div>
            <label class="form-label fw-bold mb-1">–†–µ–∂–∏–º</label>
            <select name="bulk_mode" class="form-select">
              <option value="add">–î–æ–¥–∞—Ç–∏</option>
            </select>
          </div>

          <button type="submit" class="btn btn-success w-100 mt-auto">
            ‚úì –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏
          </button>
        </div>
      </div>
    </form>
  </div>
</div>    {% if items %}
      <div class="summary-table">
        <table class="table table-bordered text-center align-middle mb-0">
            <thead>
              <tr>
                <th>‚Ññ</th>
                <th>–§–æ—Ç–æ</th>
                <th>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</th>
                <th>–ö/–° (—Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫)</th>
                <th>–¶—ñ–Ω–∞</th>
                <th>–î—ñ—è</th>
                <th>–ù–∞—Ü—ñ–Ω–∫–∞ %</th>
                <th style="width:40px;">
                      <input id="selectAllItems" type="checkbox" class="form-check-input">
                </th>
              </tr>
            </thead>
          <tbody>
            {% for i in items %}
                <tr>
                  <!-- ‚Ññ -->
                  <td class="fw-bold">{{ forloop.counter }}</td>

                  <!-- –§–æ—Ç–æ -->
                  <td>
                    {% with first_product=i.products.all|first %}
                      {% if first_product and first_product.image %}
                        <img src="{{ first_product.image.url }}" alt="{{ first_product.name }}">
                      {% else %}
                        <img src="https://via.placeholder.com/50x50?text=No+Img">
                      {% endif %}
                    {% endwith %}
                  </td>

                  <!-- –ù–∞–∑–≤–∞ –ø–æ–∑–∏—Ü—ñ—ó -->
                  <td>
                    {{ i.name }}
                    {% if i.quantity > 1 %}
                      <span class="badge bg-light text-dark ms-1">√ó {{ i.quantity }}</span>
                    {% endif %}
                  </td>

                  <!-- üî• –ö/–° –ø–æ–≤–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ -->
                    <td class="text-start">
                  <span class="ks-tooltip" data-tooltip="{{ i.ks_tooltip }}">
                    {{ i.ks_formula }} =
                    <strong>{{ i.ks_effective|floatformat:2 }}</strong> –∫/—Å
                  </span>
                </td>
                  </td>

                  <!-- –¶—ñ–Ω–∞ -->
                  <td class="fw-bold text-success">
                    {{ i.total_cost_value|floatformat:2 }} –≥—Ä–Ω
                  </td>

                  <!-- –î—ñ—è -->
                  <td>
                    <a href="{% url 'order_item_edit' i.id %}"
                       class="btn btn-sm btn-outline-secondary">
                       ‚úèÔ∏è
                    </a>
                  </td>
                    <td style="min-width:140px;">
                        <input type="number" step="0.01"
                               name="item_markup_{{ i.id }}"
                               value="{{ i.markup_percent|default_if_none:'' }}"
                               form="saveMarkupForm">
                      <div class="small text-muted">
                        –∑–∞—Ä–∞–∑: {{ i.effective_markup_percent|default:"" }}
                      </div>
                    </td>
                    <td style="width:40px;">
                      <input type="checkbox"
                             class="form-check-input item-select"
                             name="selected_item_ids"
                             value="{{ i.id }}"
                             form="bulkCoeffsForm">
                    </td>
                </tr>
                {% endfor %}
          </tbody>
        </table>
      </div>
                {% if request.user.is_superuser %}
    <div class="card shadow-sm my-4" style="border-left: 6px solid #28a745;">
        <div class="card-body">
            <h4 class="text-success fw-bold mb-3">
                üí∞ –ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: {{ total|floatformat:2 }} –≥—Ä–Ω
            </h4>

            <hr>

            <h5 class="fw-bold text-primary text-center mb-3">–§–æ—Ä–º—É–ª–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</h5>

            <div class="p-3 bg-light rounded border text-center">

                <div class="mb-2 text-secondary">
                    <span class="fw-bold">Œ£ –∫/—Å:</span>
                    {{ effective_ks|floatformat:2 }} –∫/—Å
                </div>

                <div class="formula-box fw-bold fs-5 my-2">
                    ({{ formula_expression }})
                    √ó {{ rate|floatformat:2 }} –≥—Ä–Ω
                </div>

                <div class="fs-5">
                    = <span class="text-success fw-bold">{{ total|floatformat:2 }} –≥—Ä–Ω</span>
                </div>

            </div>

        </div>
    </div>

      <div class="text-center mt-4">
        <button id="finishOrder" class="btn btn-primary px-4 py-2">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>

      <div id="finalForm" class="final-form mt-3">
        <h5 class="fw-bold mb-3">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">–î–æ—Å—Ç–∞–≤–∫–∞ (–≥—Ä–Ω)</label>
            <input type="number" id="deliveryCost" class="form-control" placeholder="300">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">–ü–∞–∫—É–≤–∞–Ω–Ω—è (–≥—Ä–Ω)</label>
            <input type="number" id="packingCost" class="form-control" placeholder="200">
          </div>
        </div>
            <div class="text-center mt-4">

              <!-- –î–µ—Ç–∞–ª—å–Ω–∏–π PDF (–ø–µ—Ä–µ–≥–ª—è–¥) -->
              <button id="calcFinalDetailed" class="btn btn-success me-2">
                üìÑ –î–µ—Ç–∞–ª—å–Ω–∏–π (–ø–µ—Ä–µ–≥–ª—è–¥)
              </button>

              <!-- –î–µ—Ç–∞–ª—å–Ω–∏–π PDF (–∑–∞–≤–∞–Ω—Ç.) -->
              <button id="calcFinalDetailedDownload" class="btn btn-success me-4">
                üíæ –î–µ—Ç–∞–ª—å–Ω–∏–π (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏)
              </button>

              <!-- –°–ø—Ä–æ—â–µ–Ω–∏–π PDF (–ø–µ—Ä–µ–≥–ª—è–¥) -->
              <button id="calcFinalShort" class="btn btn-outline-primary me-2">
                üìÑ –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è (–ø–µ—Ä–µ–≥–ª—è–¥)
              </button>

              <!-- –°–ø—Ä–æ—â–µ–Ω–∏–π PDF (–∑–∞–≤–∞–Ω—Ç.) -->
              <button id="calcFinalShortDownload" class="btn btn-outline-primary">
                üíæ –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è (–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏)
              </button>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button type="button" id="btnSyncPrecalc" class="btn btn-warning">
                üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ (–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π)
              </button>

              <button type="button" id="btnSyncFinal" class="btn btn-warning">
                üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ (–≤ —Ä–æ–±–æ—Ç—É)
              </button>

              <span id="syncStatus" class="ms-2 text-muted"></span>
            </div>

            <!-- –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–±–æ—Ä—É –ø–∞–ø–∫–∏ -->
            <div id="syncFolderChooser" class="mt-3 d-flex flex-wrap gap-2"></div>
      </div>
    {% endif %}
  </div>
                    {% endif %}

</div>
{{# ===== JS: –¥–∞–Ω—ñ –º—ñ—Ç–æ–∫ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ===== #}
<script>
  const markersByImage = {
    {% for image_id, markers in markers_by_image.items %}
      "{{ image_id }}": [
        {% for m in markers %}
          {
            x: "{{ m.x }}",
            y: "{{ m.y }}",
            item: "{{ m.item_name|escapejs }}",
            color: "{{ m.color }}"
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]{% if not forloop.last %},{% endif %}
    {% endfor %}
  };
</script>
<script>
const syncStatus = document.getElementById("syncStatus");
const chooser = document.getElementById("syncFolderChooser");

const orderId = "{{ order.id }}";  // –∞–±–æ —è–∫ —Ç–∏ –ø–µ—Ä–µ–¥–∞—î—à id
const syncUrl = `/orders/${orderId}/sync-internal-pdf/`;

function setStatus(text, cls = "text-muted") {
  syncStatus.className = "ms-2 " + cls;
  syncStatus.textContent = text;
}

async function runSync(mode, extraPayload = {}) {
  chooser.innerHTML = "";
  setStatus("–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è‚Ä¶", "text-muted");

  const payload = {
    mode: mode,
    markup: window.ORDER_MARKUP || 0,
    delivery: window.ORDER_DELIVERY || 0,
    packing: window.ORDER_PACKING || 0,
    ...extraPayload
  };

  const resp = await fetch(syncUrl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify(payload)
  });

  const data = await resp.json();

  // ‚úÖ –£—Å–ø—ñ—Ö
  if (resp.ok && data.ok) {
    setStatus(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ (${data.uploaded_to} –ø–∞–ø–∫.)`, "text-success");
    return;
  }

  // üîÅ –ü–æ—Ç—Ä—ñ–±–µ–Ω –≤–∏–±—ñ—Ä –ø–∞–ø–∫–∏
  if (resp.status === 409 && data.candidates) {
    setStatus("–û–±–µ—Ä—ñ—Ç—å –ø–∞–ø–∫—É –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó:", "text-warning");
    renderFolderButtons(mode, data.candidates);
    return;
  }

  // ‚ùå –ü–æ–º–∏–ª–∫–∞
  setStatus(`‚ùå ${data.error || "–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó"}`, "text-danger");
}

function renderFolderButtons(mode, folders) {
  chooser.innerHTML = "";

  folders.forEach(f => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn btn-outline-primary btn-sm";
    btn.textContent = f.name || "–ë–µ–∑ –Ω–∞–∑–≤–∏";
    btn.title = f.webUrl || "";

    btn.onclick = () => {
      runSync(mode, { target_folder_id: f.id });
    };

    chooser.appendChild(btn);
  });

  // –∫–Ω–æ–ø–∫–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è
  const cancel = document.createElement("button");
  cancel.type = "button";
  cancel.className = "btn btn-outline-secondary btn-sm";
  cancel.textContent = "‚úñ –°–∫–∞—Å—É–≤–∞—Ç–∏";
  cancel.onclick = () => {
    chooser.innerHTML = "";
    setStatus("–°–∫–∞—Å–æ–≤–∞–Ω–æ", "text-muted");
  };
  chooser.appendChild(cancel);
}

// –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç—É
document.getElementById("btnSyncPrecalc").onclick = () => runSync("precalc");
document.getElementById("btnSyncFinal").onclick   = () => runSync("final");
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn     = document.getElementById("toggleSketch");
  const restoreBtn    = document.getElementById("restoreSketch");
  const sketchSection = document.getElementById("sketch-section");
  const finishBtn     = document.getElementById("finishOrder");
  const finalForm     = document.getElementById("finalForm");

  const btnCat   = document.getElementById("viewByCategories");
  const btnFlat  = document.getElementById("viewFlatList");
  const blockCat = document.getElementById("productsByCategories");
  const blockFlat= document.getElementById("productsFlatList");

  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è "–ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö" / "–ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫"
  if (btnCat && btnFlat && blockFlat) {
    btnCat.addEventListener("click", () => {
      if (blockCat) blockCat.style.display = "block";
      blockFlat.style.display = "none";
      btnCat.classList.add("btn-primary");
      btnCat.classList.remove("btn-outline-primary");
      btnFlat.classList.add("btn-outline-secondary");
      btnFlat.classList.remove("btn-secondary");
    });

    btnFlat.addEventListener("click", () => {
      if (blockCat) blockCat.style.display = "none";
      blockFlat.style.display = "block";
      btnFlat.classList.add("btn-secondary");
      btnFlat.classList.remove("btn-outline-secondary");
      btnCat.classList.add("btn-outline-primary");
      btnCat.classList.remove("btn-primary");
    });

    // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
    btnFlat.click();
  }

  // –ó–≥–æ—Ä—Ç–∞–Ω–Ω—è / –ø–æ–∫–∞–∑ –µ—Å–∫—ñ–∑—É
  if (toggleBtn && restoreBtn && sketchSection) {
    toggleBtn.addEventListener("click", () => {
      sketchSection.classList.add("collapsed");
      toggleBtn.style.display = "none";
      restoreBtn.style.display = "block";
    });

    restoreBtn.addEventListener("click", () => {
      sketchSection.classList.remove("collapsed");
      toggleBtn.style.display = "block";
      restoreBtn.style.display = "none";
    });
  }

  // –ü–æ–∫–∞–∑ —Ñ—ñ–Ω–∞–ª—å–Ω–æ—ó —Ñ–æ—Ä–º–∏
  if (finishBtn && finalForm) {
    finishBtn.addEventListener("click", () => {
      finalForm.classList.toggle("visible");
    });
  }

  // ===== –ö–Ω–æ–ø–∫–∏ PDF (–ø–µ—Ä–µ–≥–ª—è–¥ + –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è) =====
  const btnPdfDetailed          = document.getElementById("calcFinalDetailed");
  const btnPdfDetailedDownload  = document.getElementById("calcFinalDetailedDownload");
  const btnPdfShort             = document.getElementById("calcFinalShort");
  const btnPdfShortDownload     = document.getElementById("calcFinalShortDownload");
  const pdfBaseUrl              = "{% url 'generate_pdf' order.id %}";

  function buildPdfUrl({ isSimple, download }) {
    const markupVal   = parseFloat(document.getElementById("markup")?.value || 0) || 0;
    const deliveryVal = parseFloat(document.getElementById("deliveryCost")?.value || 0) || 0;
    const packingVal  = parseFloat(document.getElementById("packingCost")?.value  || 0) || 0;

    let url = `${pdfBaseUrl}?markup=${markupVal}&delivery=${deliveryVal}&packing=${packingVal}`;
    if (isSimple) {
      url += "&simple=1";
    }
    if (download) {
      url += "&download=1";
    }
    return url;
  }

  // –î–µ—Ç–∞–ª—å–Ω–∏–π ‚Äî –ø–µ—Ä–µ–≥–ª—è–¥
  if (btnPdfDetailed) {
    btnPdfDetailed.addEventListener("click", () => {
      const url = buildPdfUrl({ isSimple: false, download: false });
      window.open(url, "_blank");
    });
  }

  // –î–µ—Ç–∞–ª—å–Ω–∏–π ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  if (btnPdfDetailedDownload) {
    btnPdfDetailedDownload.addEventListener("click", () => {
      const url = buildPdfUrl({ isSimple: false, download: true });
      window.location.href = url;
    });
  }

  // –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è ‚Äî –ø–µ—Ä–µ–≥–ª—è–¥
  if (btnPdfShort) {
    btnPdfShort.addEventListener("click", () => {
      const url = buildPdfUrl({ isSimple: true, download: false });
      window.open(url, "_blank");
    });
  }

  // –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  if (btnPdfShortDownload) {
    btnPdfShortDownload.addEventListener("click", () => {
      const url = buildPdfUrl({ isSimple: true, download: true });
      window.location.href = url;
    });
  }
   const btnSyncPrecalc = document.getElementById("btnSyncPrecalc");
  const btnSyncFinal   = document.getElementById("btnSyncFinal");
  const syncStatus     = document.getElementById("syncStatus");

  // –í–ê–ñ–õ–ò–í–û: –¥–æ–¥–∞–π —É urls.py route –∑ name="sync_internal_pdf"
  const syncUrl = "{% url 'sync_internal_pdf' order.id %}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function syncInternalPdf(mode) {
    const markupVal   = parseFloat(document.getElementById("markup")?.value || 0) || 0;
    const deliveryVal = parseFloat(document.getElementById("deliveryCost")?.value || 0) || 0;
    const packingVal  = parseFloat(document.getElementById("packingCost")?.value  || 0) || 0;

    syncStatus.textContent = "–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...";
    const csrftoken = getCookie("csrftoken");

    const resp = await fetch(syncUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({
        mode,                 // "precalc" –∞–±–æ "final"
        markup: markupVal,
        delivery: deliveryVal,
        packing: packingVal,
      }),
    });

    const data = await resp.json();
    if (!resp.ok || !data.ok) {
      syncStatus.textContent = data?.error || "–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó";
      return;
    }

    syncStatus.textContent = `–ì–æ—Ç–æ–≤–æ ‚úÖ –ó–∞–ª–∏—Ç–æ –≤ –ø–∞–ø–æ–∫: ${data.uploaded_to}`;
  }

  if (btnSyncPrecalc) btnSyncPrecalc.addEventListener("click", () => syncInternalPdf("precalc"));
  if (btnSyncFinal)   btnSyncFinal.addEventListener("click", () => syncInternalPdf("final"));

  // ---- –ì–∞–ª–µ—Ä–µ—è + –º—ñ—Ç–∫–∏ ----
  const mainImage   = document.getElementById("mainImage");
  const markerLayer = document.getElementById("markerLayer");
  const thumbs      = document.querySelectorAll(".thumb-img");
  const annotateBtn = document.getElementById("annotateBtn");

    function renderMarkers(imageId) {
  if (!markerLayer) return;
  markerLayer.innerHTML = "";
  if (!imageId) return;

  const arr = markersByImage[imageId] || [];
  arr.forEach(m => {
    const dot = document.createElement("div");
    dot.className = "marker-dot";

    const color = m.color || "#ff4d4f";

    const x = parseFloat(String(m.x).replace(",", "."));
    const y = parseFloat(String(m.y).replace(",", "."));

    if (Number.isFinite(x)) dot.style.left = x + "%";
    if (Number.isFinite(y)) dot.style.top  = y + "%";

    dot.style.borderColor = color;
    dot.style.backgroundColor = color + "33";
    dot.dataset.label = m.item || "";
    markerLayer.appendChild(dot);
  });}

  if (thumbs.length && mainImage) {
    thumbs.forEach(t => {
      t.addEventListener("click", () => {
        thumbs.forEach(x => x.classList.remove("active"));
        t.classList.add("active");

        mainImage.src = t.dataset.full;
        mainImage.dataset.imageId = t.dataset.imageId || "";

        if (annotateBtn && t.dataset.imageId) {
          annotateBtn.href = "{% url 'annotate_order_image' 0 %}"
            .replace("/0/", `/${t.dataset.imageId}/`);
        }

        renderMarkers(mainImage.dataset.imageId);
      });
    });

    renderMarkers(mainImage.dataset.imageId || "");
  }

  // –ê–∫–∫–æ—Ä–¥–µ–æ–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
  const categoryToggles = document.querySelectorAll(".category-toggle-btn, .category-header");
  categoryToggles.forEach(el => {
    el.addEventListener("click", () => {
      const targetId = el.getAttribute("data-target");
      if (!targetId) return;
      const body = document.getElementById(targetId);
      if (!body) return;

      const btn = document.querySelector(`.category-toggle-btn[data-target="${targetId}"]`);
      if (!btn) return;

      const textSpan = btn.querySelector(".text");

      body.classList.toggle("collapsed");
      btn.classList.toggle("collapsed");

      if (body.classList.contains("collapsed")) {
        if (textSpan) textSpan.textContent = "–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏";
      } else {
        if (textSpan) textSpan.textContent = "–ó–≥–æ—Ä–Ω—É—Ç–∏";
      }
    });
  });

  // ---- –ó–∞–º–æ–≤–Ω–∏–∫: —ñ—Å–Ω—É—é—á–∏–π / –Ω–æ–≤–∏–π + –∞–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ----
  const customerForm = document.getElementById("customerForm");
  const select    = document.getElementById("existingCustomerSelect");
  const newFields = document.getElementById("newCustomerFields");
  const saveBtn   = document.getElementById("saveNewCustomerBtn");

  if (select && newFields && saveBtn && customerForm) {
    // –ü–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≤ –Ω–æ–≤–æ–≥–æ –∑–∞–º–æ–≤–Ω–∏–∫–∞
    select.addEventListener("change", () => {
      if (select.value === "") {
        // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–æ–≥–æ
        newFields.style.display = "flex";
        saveBtn.style.display   = "block";
      } else {
        // –û–±—Ä–∞–ª–∏ —ñ—Å–Ω—É—é—á–æ–≥–æ
        newFields.style.display = "none";
        saveBtn.style.display   = "none";
        // üî• –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–æ—Ä–º—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è order.customer
        customerForm.submit();
      }
    });
  }

  // ---- –í–∏–±—ñ—Ä –Ω–æ–º–µ—Ä–∞ –ø–æ–∑–∏—Ü—ñ—ó + –∞–≤—Ç–æ–ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó ----
  const posSelect = document.getElementById("positionNumberSelect");
  const posInput  = document.getElementById("positionNameInput");

  function updatePositionNameFromSelection() {
    if (!posInput) return;

    const firstChecked = document.querySelector('input[name="products"]:checked');
    const categoryName = firstChecked ? (firstChecked.dataset.category || "") : "";

    const num = posSelect && posSelect.value ? posSelect.value : "";

    if (categoryName) {
      posInput.value = (num ? num + ". " : "") + categoryName;
    } else if (num) {
      posInput.value = num;
    }
  }

  if (posSelect && posInput) {
    // —Å—Ç–≤–æ—Ä—é—î–º–æ –æ–ø—Ü—ñ—ó 1‚Äì100
    for (let i = 1; i <= 100; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      posSelect.appendChild(opt);
    }

    posSelect.addEventListener("change", updatePositionNameFromSelection);
  }

  const productCheckboxes = document.querySelectorAll('input[name="products"]');
  productCheckboxes.forEach(cb => {
    cb.addEventListener("change", updatePositionNameFromSelection);
  });

  // ---- –ê–≤—Ç–æ–ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–∑–≤–∏ —ñ–∑ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ + –¥–æ–¥–∞–≤–∞–Ω–Ω—è ----
  const orderNameInput = document.getElementById("orderNameInput");
  const orderNameTemplateSelect = document.getElementById("orderNameTemplateSelect");
  const addBtn = document.getElementById("addOrderNameBtn");

  if (orderNameTemplateSelect && orderNameInput) {
    orderNameTemplateSelect.addEventListener("change", () => {
      const text = orderNameTemplateSelect.selectedOptions[0].text;
      if (orderNameTemplateSelect.value) {
        orderNameInput.value = text;
      }
    });
  }

  if (addBtn && orderNameInput && orderNameTemplateSelect) {
    addBtn.addEventListener("click", async (e) => {
      e.preventDefault();

      const newName = orderNameInput.value.trim();
      if (!newName) {
        alert("–°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É");
        return;
      }

      try {
        const response = await fetch("{% url 'add_order_name' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ name: newName })
        });

        if (!response.ok) {
          alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ");
          return;
        }

        const data = await response.json();

        const option = document.createElement("option");
        option.value = data.id;
        option.textContent = data.name;
        orderNameTemplateSelect.appendChild(option);
        orderNameTemplateSelect.value = data.id;

        alert("–î–æ–¥–∞–Ω–æ –≤ –¥–æ–≤—ñ–¥–Ω–∏–∫!");
      } catch (e) {
        console.error(e);
        alert("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ.");
      }
    });
  }
});
</script>

<script>
// üîç –ó—É–º + –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è (—Ä—É—Ö–∞—î–º–æ –≤–µ—Å—å mainImageInner —Ä–∞–∑–æ–º –∑ –º—ñ—Ç–∫–∞–º–∏)
(function () {
  const wrapper = document.getElementById("mainImageWrapper");
  const inner   = document.getElementById("mainImageInner");
  if (!wrapper || !inner) return;

  let scale = 1;
  const MIN_SCALE = 1;
  const MAX_SCALE = 4;
  let posX = 0;
  let posY = 0;

  let isDragging = false;
  let dragStartX = 0;
  let dragStartY = 0;

  function updateTransform() {
    inner.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
  }

  wrapper.addEventListener('wheel', (e) => {
    e.preventDefault();

    const delta = e.deltaY < 0 ? 0.15 : -0.15;
    const prevScale = scale;
    scale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, scale + delta));

    const rect = wrapper.getBoundingClientRect();
    const offsetX = e.clientX - rect.left;
    const offsetY = e.clientY - rect.top;

    const dx = offsetX - rect.width / 2;
    const dy = offsetY - rect.height / 2;

    const scaleRatio = scale / prevScale;

    posX = posX * scaleRatio + dx * (scaleRatio - 1);
    posY = posY * scaleRatio + dy * (scaleRatio - 1);

    if (scale === MIN_SCALE) {
      posX = 0;
      posY = 0;
    }

    updateTransform();
  }, { passive: false });

  wrapper.addEventListener('mousedown', (e) => {
    if (scale === MIN_SCALE) return;
    isDragging = true;
    wrapper.classList.add('dragging');
    dragStartX = e.clientX - posX;
    dragStartY = e.clientY - posY;
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    posX = e.clientX - dragStartX;
    posY = e.clientY - dragStartY;
    updateTransform();
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    wrapper.classList.remove('dragging');
  });

  wrapper.addEventListener('touchstart', (e) => {
    if (scale === MIN_SCALE) return;
    const touch = e.touches[0];
    isDragging = true;
    wrapper.classList.add('dragging');
    dragStartX = touch.clientX - posX;
    dragStartY = touch.clientY - posY;
  }, { passive: true });

  wrapper.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    const touch = e.touches[0];
    posX = touch.clientX - dragStartX;
    posY = touch.clientY - dragStartY;
    updateTransform();
  }, { passive: true });

  wrapper.addEventListener('touchend', () => {
    isDragging = false;
    wrapper.classList.remove('dragging');
  });
})();
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("preview script loaded");

  const previewBox = document.getElementById("pdfPreviewBox");
  const pdfEmbed   = document.getElementById("pdfEmbed");
  const closeBtn   = document.getElementById("closePreview");

  // –î–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ–∫—É (–ø—Ä–∞—Ü—é—î –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è/–æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è)
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".js-preview");
    if (!btn) return;

    e.preventDefault();
    const url = btn.getAttribute("data-preview-url");
    console.log("clicked preview, url=", url);

    if (!url) {
      alert("–ù–µ–º–∞—î data-preview-url –Ω–∞ –∫–Ω–æ–ø—Ü—ñ");
      return;
    }

    // —Ñ–æ—Ä—Å–∏–º–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è embed
    pdfEmbed.src = "";
    setTimeout(() => {
      pdfEmbed.src = url;
      previewBox.style.display = "block";
    }, 0);
  });

  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      previewBox.style.display = "none";
      pdfEmbed.src = "";
    });
  }
});
</script>
<script>
  (function () {
    const selectAll = document.getElementById('selectAllItems');
    if (!selectAll) return;

    selectAll.addEventListener('change', () => {
      document.querySelectorAll('.item-select').forEach(cb => {
        cb.checked = selectAll.checked;
      });
    });
  })();
  function syncQtyForCheckbox(cb) {
    const row = cb.closest(".product-option");
    if (!row) return;
    const qty = row.querySelector(".prod-qty");
    if (!qty) return;

    qty.disabled = !cb.checked;
    if (!cb.checked) qty.value = 1;
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 1) —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    document.querySelectorAll(".product-check").forEach(syncQtyForCheckbox);
  });

  // 2) —ñ –ø—Ä–∏ –∑–º—ñ–Ω—ñ
  document.addEventListener("change", (e) => {
    if (!e.target.classList.contains("product-check")) return;
    syncQtyForCheckbox(e.target);
  });

document.addEventListener("DOMContentLoaded", () => {
  const hidePart = document.getElementById("sketchHidePart");
  const sketchSection = document.getElementById("sketch-section");

  let btnHide = document.getElementById("toggleSketch");
  let btnShow = document.getElementById("restoreSketch");

  if (!hidePart || !sketchSection || !btnHide || !btnShow) return;

  // 1) –ó–Ω—ñ–º–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ "collapsed" –∫–ª–∞—Å–∏, —è–∫—ñ —Ö–æ–≤–∞—é—Ç—å –í–°–ï
  sketchSection.classList.remove("collapsed");

  // 2) –í–ê–ñ–õ–ò–í–û: –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ä—ñ event listeners (clone node trick)
  const btnHideClean = btnHide.cloneNode(true);
  btnHide.parentNode.replaceChild(btnHideClean, btnHide);
  btnHide = btnHideClean;

  const btnShowClean = btnShow.cloneNode(true);
  btnShow.parentNode.replaceChild(btnShowClean, btnShow);
  btnShow = btnShowClean;

  // 3) –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
  btnShow.style.display = "none";
  btnHide.style.display = "inline-block";

  // 4) –ù–æ–≤—ñ (—î–¥–∏–Ω—ñ) —Ö–µ–Ω–¥–ª–µ—Ä–∏: —Ö–æ–≤–∞—î–º–æ –¢–Ü–õ–¨–ö–ò hidePart
  btnHide.addEventListener("click", (e) => {
    e.preventDefault();
    hidePart.style.display = "none";
    btnHide.style.display = "none";
    btnShow.style.display = "inline-block";
  });

  btnShow.addEventListener("click", (e) => {
    e.preventDefault();
    hidePart.style.display = "";
    btnShow.style.display = "none";
    btnHide.style.display = "inline-block";
  });
});
</script>
{% endblock %}
