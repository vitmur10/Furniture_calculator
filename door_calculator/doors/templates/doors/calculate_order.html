{% extends 'base.html' %}
{% block content %}
<style>
  .order-layout {
    display: flex;
    flex-wrap: nowrap;
    height: auto;
    min-height: calc(100vh - 120px);
    overflow: visible;
    transition: all 0.4s ease;
    align-items: flex-start;
  }

  .order-sketch {
    flex: 0 0 420px;
    max-width: 420px;
    background: transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    border-right: 3px solid #0d6efd22;
    position: sticky;          /* üî• —Ä–æ–±–∏–º–æ –∫–æ–ª–æ–Ω–∫—É ¬´–ª–∏–ø–∫–æ—é¬ª */
    top: 80px;                 /* –≤—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç—Ü—ñ */
    align-self: flex-start;    /* —â–æ–± sticky –ø—Ä–∞—Ü—é–≤–∞–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ flex */
    transition: all 0.4s ease;
    padding: 20px;
    box-sizing: border-box;
    overflow: hidden;
  }

  .order-sketch.collapsed {
    flex: 0;
    opacity: 0;
    visibility: hidden;
    width: 0;
  }

  .order-sketch.dragging {
    cursor: grabbing;
  }

  .main-image-wrapper {
    width: 100%;
    height: 380px;
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.3);
    overflow: hidden;
    position: relative;
    background: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
  }

  .main-image-inner {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transform-origin: center center;
    transition: transform 0.05s linear;
  }

  .main-image-inner img {
    width: 100%;
    height: auto;
    max-height: 100%;
    object-fit: contain;
    user-select: none;
    pointer-events: auto;
  }

  .marker-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .marker-dot {
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid red;
    background: rgba(255,0,0,0.25);
    transform: translate(-50%, -50%);
  }

  .marker-dot::after {
    content: attr(data-label);
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: #fff;
    background: rgba(0,0,0,0.6);
    padding: 1px 4px;
    border-radius: 4px;
    white-space: nowrap;
  }

  .zoom-hint {
    position: absolute;
    right: 10px;
    bottom: 10px;
    font-size: 12px;
    padding: 5px 9px;
    background: rgba(255,255,255,.9);
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,.08);
    z-index: 5;
  }

  .thumbs-row {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    max-height: 110px;
    overflow-y: auto;
  }

  .thumbs-row img {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.1s, border-color 0.1s;
  }

  .thumbs-row img.active {
    border-color: #0d6efd;
  }

  .thumbs-row img:hover {
    transform: scale(1.05);
  }

  .toggle-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.85);
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-weight: 600;
    cursor: pointer;
    z-index: 10;
    transition: all 0.25s ease;
  }
  .toggle-btn:hover {
    background: #0d6efd;
    color: #fff;
  }

  #restoreSketch {
    display: none;
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 1000;
    background: #0d6efd;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }
  #restoreSketch:hover { background: #0b5ed7; }

  .order-form {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    background: var(--card-bg);
  }

  .product-option {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: .75rem;
    background: var(--card-bg);
    border-radius: 8px;
    padding: 6px 10px;
    transition: background 0.25s ease;
  }
  .product-option:hover { background: rgba(13, 110, 253, 0.05); }

  .product-option img {
    width: 45px;
    height: 45px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #ccc;
    transition: transform 0.2s ease;
  }
  .product-option img:hover { transform: scale(1.05); }

  .summary-table img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .summary-table th {
    background-color: #0d6efd;
    color: #fff;
  }

  .total-box {
    font-size: 1.3rem;
    font-weight: bold;
    text-align: center;
    background: #d1e7dd;
    color: #51aa16;
    padding: 0.8rem;
    border-radius: 12px;
    margin-top: 1.2rem;
  }

  .final-form {
    display: none;
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }
  .final-form.visible {
    display: block;
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .category-card { background: #fff; }
  .category-card h6 { margin-bottom: .5rem; }

  .floating-upload {
    margin-top: 12px;
    width: 100%;
  }

  /* üîΩ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π */
  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .category-toggle-btn {
    border: none;
    background: transparent;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: #0d6efd;
  }

  .category-toggle-btn .icon {
    display: inline-block;
    transition: transform 0.2s ease;
  }

  .category-body.collapsed {
    display: none;
  }

  .category-toggle-btn.collapsed .icon {
    transform: rotate(-90deg);
  }

  @media (max-width: 991px) {
    .order-layout { flex-direction: column; height: auto; }
    .order-sketch {
      flex: none;
      max-width: 100%;
      width: 100%;
      border-right: none;
      border-bottom: 3px solid #0d6efd22;
      position: static;  /* –Ω–∞ –º–æ–±—ñ–ª—Ü—ñ –∑–∞–±–∏—Ä–∞—î–º–æ sticky, —â–æ–± –Ω–µ –ª–∞–º–∞–ª–æ –≤–µ—Ä—Å—Ç–∫—É */
      top: auto;
    }
  }
</style>

<button id="restoreSketch">üìà –ü–æ–∫–∞–∑–∞—Ç–∏ –µ—Å–∫—ñ–∑</button>

<div class="order-layout">
  <!-- üîπ –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –≥–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ -->
  <div class="order-sketch" id="sketch-section">
    {% if order.images.all %}
      {% with first_img=order.images.all.0 %}
      <button class="toggle-btn" id="toggleSketch">üìâ –ó–≥–æ—Ä–Ω—É—Ç–∏</button>

      <div class="main-image-wrapper" id="mainImageWrapper">
        <div class="main-image-inner" id="mainImageInner">
          <img src="{{ first_img.image.url }}"
               alt="–ï—Å–∫—ñ–∑ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
               id="mainImage"
               data-image-id="{{ first_img.id }}">

          {# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≤ —è–∫–∏–π JS –¥–æ–º–∞–ª—é—î –º—ñ—Ç–∫–∏ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è #}
          <div class="marker-layer" id="markerLayer"></div>
        </div>
        <div class="zoom-hint">
          –ö–æ–ª—ñ—â–∞—Ç–∫–æ ‚Äî –∑—É–º, –º–∏—à–∫–æ—é ‚Äî –ø–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏
        </div>
      </div>

      <a href="{% url 'annotate_order_image' first_img.id %}"
         class="btn btn-outline-secondary btn-sm w-100 mt-2"
         id="annotateBtn">
        üñäÔ∏è –†–æ–∑–º—ñ—Ç–∏—Ç–∏ —Ñ–æ—Ç–æ
      </a>

      <div class="thumbs-row mt-2">
        {% for img in order.images.all %}
          <img src="{{ img.image.url }}"
               class="thumb-img {% if forloop.first %}active{% endif %}"
               data-full="{{ img.image.url }}"
               data-image-id="{{ img.id }}">
        {% endfor %}
      </div>
      {% endwith %}
    {% else %}
      <div class="text-muted small mb-2">–§–æ—Ç–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ</div>
    {% endif %}

    <!-- —Ñ–æ—Ä–º–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ -->
    <form method="post" enctype="multipart/form-data" class="floating-upload">
      {% csrf_token %}
      <input type="hidden" name="upload_images" value="1">
      <div class="d-flex flex-column gap-2">
        <input type="file" name="images" accept="image/*" multiple
               class="form-control form-control-sm">
        <button class="btn btn-sm btn-primary">‚¨ÜÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ (–¥–æ 50)</button>
      </div>
    </form>

    <!-- —Ñ–æ—Ä–º–∞ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤ (–∫—Ä–µ—Å–ª–µ–Ω–Ω—è/–ø—ñ–¥—Ä–∞—Ö—É–Ω–∫–∏) -->
    <form method="post" enctype="multipart/form-data" class="floating-upload mt-3">
      {% csrf_token %}
      <input type="hidden" name="upload_files" value="1">
      <div class="d-flex flex-column gap-2">
        <input type="file" name="files" multiple
               class="form-control form-control-sm">
        <input type="text" name="files_desc"
               class="form-control form-control-sm"
               placeholder="–ó–∞–≥–∞–ª—å–Ω–∏–π –æ–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)">
        <button class="btn btn-sm btn-outline-secondary">üìé –î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª–∏</button>
      </div>
    </form>

    {% if order.files.all %}
      <div class="mt-3 w-100">
        <h6 class="fw-bold mb-2">–ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏:</h6>
        <ul class="list-unstyled small">
          {% for f in order.files.all %}
            <li class="mb-2">
              <form method="post" class="d-flex align-items-center gap-2">
                {% csrf_token %}

                <a href="{{ f.file.url }}" target="_blank" class="text-decoration-none flex-grow-1">
                  üìÑ {{ f.description|default:f.file.name|cut:"order_files/" }}
                </a>

                <input type="text"
                       name="file_desc"
                       value="{{ f.description|default:f.file.name|cut:'order_files/' }}"
                       class="form-control form-control-sm"
                       style="max-width: 220px;">

                <button type="submit"
                        name="update_file"
                        value="{{ f.id }}"
                        class="btn btn-sm btn-outline-primary">
                  üíæ
                </button>

                <button type="submit"
                        name="delete_file"
                        value="{{ f.id }}"
                        class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª?');">
                  üóë
                </button>
              </form>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>

  <!-- üîπ –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
    {% if request.user.is_superuser %}

  <div class="order-form">
    <h4 class="fw-bold mb-2">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ{{ order.order_number }}</h4>
    <p class="text-muted mb-4">–í–∞—Ä—Ç—ñ—Å—Ç—å 1 –∫/—Å: <strong>{{ rate }} –≥—Ä–Ω</strong></p>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary btn-sm" id="viewByCategories">
          üóÇÔ∏è –ü–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="viewFlatList">
          üìÑ –ü–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
        </button>
      </div>
    </div>

    <!-- üîπ –ë–ª–æ–∫ –¥–∞–Ω–∏—Ö –∑–∞–º–æ–≤–Ω–∏–∫–∞ -->
    <div class="mb-4 border rounded p-3 bg-white">
      <form method="post" class="row g-2 align-items-end" id="customerForm">
        {% csrf_token %}
        <input type="hidden" name="assign_customer" value="1">

        <div class="col-12">
          <label class="form-label fw-bold mb-1">–ó–∞–º–æ–≤–Ω–∏–∫</label>
          <select name="existing_customer" id="existingCustomerSelect" class="form-select">
            <option value="">‚Äî –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ ‚Äî</option>
            {% for c in customers %}
            <option value="{{ c.id }}" {% if order.customer and c.id == order.customer.id %}selected{% endif %}>
              {{ c.name }}{% if c.phone %} ‚Äî {{ c.phone }}{% endif %}
            </option>
            {% endfor %}
          </select>
        </div>

        <div id="newCustomerFields" class="row g-3 mt-1"
             {% if order.customer %}style="display:none"{% endif %}>
          <div class="col-md-6">
            <label class="form-label small">–Ü–º º—è / –ö–æ–º–ø–∞–Ω—ñ—è</label>
            <input type="text"
                   name="customer_name"
                   class="form-control form-control-sm"
                   placeholder="–ù–∞–ø—Ä.: –Ü–≤–∞–Ω –∞–±–æ –¢–û–í –ë—É–¥–ú–æ–Ω—Ç–∞–∂"
                   value="{% if order.customer %}{{ order.customer.name }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="text"
                   name="customer_phone"
                   class="form-control form-control-sm"
                   placeholder="+38 (0__) ___ __ __"
                   value="{% if order.customer and order.customer.phone %}{{ order.customer.phone }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">Email</label>
            <input type="email"
                   name="customer_email"
                   class="form-control form-control-sm"
                   placeholder="example@gmail.com"
                   value="{% if order.customer and order.customer.email %}{{ order.customer.email }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
            <input type="text"
                   name="customer_address"
                   class="form-control form-control-sm"
                   placeholder="–ú—ñ—Å—Ç–æ, –≤—É–ª–∏—Ü—è, –±—É–¥–∏–Ω–æ–∫"
                   value="{% if order.customer and order.customer.address %}{{ order.customer.address }}{% endif %}">
          </div>

          <div class="col-md-6">
            <label class="form-label small">–Ñ–î–†–ü–û–£ / –Ü–ü–ù</label>
            <input type="text"
                   name="customer_company_code"
                   class="form-control form-control-sm"
                   placeholder="–¢—ñ–ª—å–∫–∏ –¥–ª—è —é—Ä. –æ—Å—ñ–±"
                   value="{% if order.customer and order.customer.company_code %}{{ order.customer.company_code }}{% endif %}">
          </div>
        </div>

        <div id="saveNewCustomerBtn" class="mt-3"
             {% if order.customer %}style="display:none"{% endif %}>
          <button class="btn btn-success btn-sm w-100">
            üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–º–æ–≤–Ω–∏–∫–∞
          </button>
        </div>
      </form>
    </div>

    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label class="form-label fw-bold">–ù–∞–∑–≤–∞ –ø–æ–∑–∏—Ü—ñ—ó</label>
        <input type="text" name="name" class="form-control"
               placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –î–≤–æ—Å—Ç—É–ª–∫–æ–≤—ñ –¥–≤–µ—Ä—ñ" required>
      </div>

      {% if categories %}
      <div class="mb-3" id="productsByCategories" style="display:none;">
        <label class="form-label fw-bold">–û–±–µ—Ä—ñ—Ç—å –≤–∏—Ä–æ–±–∏ (–ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö):</label>
        {% for cat in categories %}
          <div class="category-card border rounded p-3 mb-3">
            <div class="category-header"
                 data-target="cat-body-{{ cat.id }}">
              <h6 class="fw-bold mb-0">üì¶ {{ cat.name }}</h6>
              <button type="button"
                      class="category-toggle-btn btn btn-sm p-0"
                      data-target="cat-body-{{ cat.id }}">
                <span class="icon">‚ñæ</span>
                <span class="text">–ó–≥–æ—Ä–Ω—É—Ç–∏</span>
              </button>
            </div>

            <div id="cat-body-{{ cat.id }}" class="category-body mt-2">
              {% for p in cat.products.all %}
                <div class="product-option">
                  <input type="checkbox" name="products" value="{{ p.id }}" class="form-check-input">
                  {% if p.image %}
                    <img src="{{ p.image.url }}" alt="{{ p.name }}">
                  {% else %}
                    <img src="https://via.placeholder.com/50x50?text=No+Img" alt="{{ p.name }}">
                  {% endif %}
                  <label>{{ p.name }} ({{ p.base_ks }} –∫/—Å)</label>
                </div>
              {% empty %}
                <div class="text-muted small">–ù–µ–º–∞—î –≤–∏—Ä–æ–±—ñ–≤ —É —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="mb-3" id="productsFlatList">
        <label class="form-label fw-bold">–û–±–µ—Ä—ñ—Ç—å –≤–∏—Ä–æ–±–∏:</label>
        {% for p in products %}
        <div class="product-option">
          <input type="checkbox" name="products" value="{{ p.id }}" class="form-check-input">
          {% if p.image %}
            <img src="{{ p.image.url }}" alt="{{ p.name }}">
          {% else %}
            <img src="https://via.placeholder.com/50x50?text=No+Img" alt="{{ p.name }}">
          {% endif %}
          <label>{{ p.name }} ({{ p.base_ks }} –∫/—Å)</label>
        </div>
        {% endfor %}
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–∑–∏—Ü—ñ–π:</label>
        <input type="number" name="item_qty" min="1" value="1" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">–î–æ–ø–æ–≤–Ω–µ–Ω–Ω—è (–∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é):</label>
        {% for a in addons %}
        <div class="input-group mb-2">
          <div class="input-group-text">
            <input type="checkbox" name="additions" value="{{ a.id }}" class="form-check-input mt-0">
          </div>
          <span class="input-group-text w-50">{{ a.name }}</span>
          <input type="number" name="add_qty_{{ a.id }}" min="1" value="1" class="form-control">
          <span class="input-group-text">{{ a.ks_value }} –∫/—Å</span>
        </div>
        {% endfor %}
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏:</label>
        {% for c in coefficients %}
        <div class="form-check form-check-inline mb-2">
          <input type="checkbox" name="coefficients" value="{{ c.id }}" class="form-check-input">
          <label class="form-check-label">{{ c.name }} √ó{{ c.value }}</label>
        </div>
        {% endfor %}
      </div>

      <div class="text-center mb-4">
        <button type="submit" class="btn btn-danger w-100 py-2">‚ûï –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
      </div>
    </form>
      {% endif %}

    {% if items %}
      <div class="summary-table">
        <table class="table table-bordered text-center align-middle mb-0">
          <thead>
            <tr>
              <th>–§–æ—Ç–æ</th>
              <th>–ü–æ–∑–∏—Ü—ñ—è</th>
              <th>–ö/–°</th>
              <th>–¶—ñ–Ω–∞</th>
              <th>–î—ñ—è</th>
            </tr>
          </thead>
          <tbody>
            {% for i in items %}
            <tr>
              <td>
                {% with first_product=i.products.all|first %}
                  {% if first_product and first_product.image %}
                    <img src="{{ first_product.image.url }}" alt="{{ first_product.name }}">
                  {% else %}
                    <img src="https://via.placeholder.com/50x50?text=No+Img" alt="–ë–µ–∑ —Ñ–æ—Ç–æ">
                  {% endif %}
                {% endwith %}
              </td>
              <td>
                {{ i.name }}
                {% if i.quantity and i.quantity|default:1 > 1 %}
                  <span class="badge bg-light text-dark ms-1">√ó {{ i.quantity }}</span>
                {% endif %}
              </td>
              <td>{{ i.total_ks.0|floatformat:2 }} √ó {{ i.total_ks.1|floatformat:2 }}</td>
              <td>{{ i.total_cost|floatformat:2 }} –≥—Ä–Ω</td>
              <td>
                <a href="{% url 'order_item_edit' i.id %}"
                   class="btn btn-sm btn-outline-secondary">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
                {% if request.user.is_superuser %}

    <div class="card shadow-sm my-4" style="border-left: 6px solid #28a745;">
        <div class="card-body">

            <h4 class="text-success fw-bold mb-3">
                üí∞ –ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: {{ total|floatformat:2 }} –≥—Ä–Ω
            </h4>

            <hr>

            <h5 class="fw-bold text-primary text-center mb-3">–§–æ—Ä–º—É–ª–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É</h5>

            <div class="p-3 bg-light rounded border text-center">

                <div class="mb-2 text-secondary">
                    <span class="fw-bold">Œ£ –∫/—Å:</span>
                    {{ effective_ks|floatformat:2 }} –∫/—Å
                </div>

                <div class="formula-box fw-bold fs-5 my-2">
                    ({{ formula_expression }})
                    √ó {{ rate|floatformat:2 }} –≥—Ä–Ω
                </div>

                <div class="fs-5">
                    = <span class="text-success fw-bold">{{ total|floatformat:2 }} –≥—Ä–Ω</span>
                </div>

            </div>

        </div>
    </div>

      <div class="text-center mt-4">
        <button id="finishOrder" class="btn btn-primary px-4 py-2">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>

      <div id="finalForm" class="final-form mt-3">
        <h5 class="fw-bold mb-3">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">–ù–∞—Ü—ñ–Ω–∫–∞ (%)</label>
            <input type="number" id="markup" class="form-control" placeholder="10">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">–î–æ—Å—Ç–∞–≤–∫–∞ (–≥—Ä–Ω)</label>
            <input type="number" id="deliveryCost" class="form-control" placeholder="300">
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">–ü–∞–∫—É–≤–∞–Ω–Ω—è (–≥—Ä–Ω)</label>
            <input type="number" id="packingCost" class="form-control" placeholder="200">
          </div>
        </div>
        <div class="text-center mt-4">
          <button id="calcFinalDetailed" class="btn btn-success me-2">
            üìÑ –î–µ—Ç–∞–ª—å–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
          </button>
          <button id="calcFinalShort" class="btn btn-outline-primary">
            üìÑ –ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è
          </button>
        </div>
      </div>
    {% endif %}
  </div>
                    {% endif %}

</div>

{# ===== JS: –¥–∞–Ω—ñ –º—ñ—Ç–æ–∫ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è ===== #}
<script>
  const markersByImage = {
    {% for image_id, markers in markers_by_image.items %}
      "{{ image_id }}": [
        {% for m in markers %}
          {
            x: {{ m.x|floatformat:2 }},
            y: {{ m.y|floatformat:2 }},
            item: "{{ m.item_name|escapejs }}",
            color: "{{ m.color }}"
          }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]{% if not forloop.last %},{% endif %}
    {% endfor %}
  };
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn     = document.getElementById("toggleSketch");
  const restoreBtn    = document.getElementById("restoreSketch");
  const sketchSection = document.getElementById("sketch-section");
  const finishBtn     = document.getElementById("finishOrder");
  const finalForm     = document.getElementById("finalForm");

  const btnCat   = document.getElementById("viewByCategories");
  const btnFlat  = document.getElementById("viewFlatList");
  const blockCat = document.getElementById("productsByCategories");
  const blockFlat= document.getElementById("productsFlatList");

  if (btnCat && btnFlat && blockFlat) {
    btnCat.addEventListener("click", () => {
      if (blockCat) blockCat.style.display = "block";
      blockFlat.style.display = "none";
      btnCat.classList.add("btn-primary");
      btnCat.classList.remove("btn-outline-primary");
      btnFlat.classList.add("btn-outline-secondary");
      btnFlat.classList.remove("btn-secondary");
    });

    btnFlat.addEventListener("click", () => {
      if (blockCat) blockCat.style.display = "none";
      blockFlat.style.display = "block";
      btnFlat.classList.add("btn-secondary");
      btnFlat.classList.remove("btn-outline-secondary");
      btnCat.classList.add("btn-outline-primary");
      btnCat.classList.remove("btn-primary");
    });

    btnFlat.click();
  }

  if (toggleBtn && restoreBtn && sketchSection) {
    toggleBtn.addEventListener("click", () => {
      sketchSection.classList.add("collapsed");
      toggleBtn.style.display = "none";
      restoreBtn.style.display = "block";
    });

    restoreBtn.addEventListener("click", () => {
      sketchSection.classList.remove("collapsed");
      toggleBtn.style.display = "block";
      restoreBtn.style.display = "none";
    });
  }

  if (finishBtn && finalForm) {
    finishBtn.addEventListener("click", () => {
      finalForm.classList.toggle("visible");
    });
  }

  const btnPdfDetailed = document.getElementById("calcFinalDetailed");
  const btnPdfShort    = document.getElementById("calcFinalShort");
  const pdfBaseUrl     = "{% url 'generate_pdf' order.id %}";

  function openPdf(isSimple) {
    const markupVal   = parseFloat(document.getElementById("markup")?.value || 0) || 0;
    const deliveryVal = parseFloat(document.getElementById("deliveryCost")?.value || 0) || 0;
    const packingVal  = parseFloat(document.getElementById("packingCost")?.value  || 0) || 0;

    let url = `${pdfBaseUrl}?markup=${markupVal}&delivery=${deliveryVal}&packing=${packingVal}`;
    if (isSimple) url += "&simple=1";
    window.open(url, "_blank");
  }

  if (btnPdfDetailed) btnPdfDetailed.addEventListener("click", () => openPdf(false));
  if (btnPdfShort)    btnPdfShort.addEventListener("click", () => openPdf(true));

  // ---- –ì–∞–ª–µ—Ä–µ—è + –º—ñ—Ç–∫–∏ ----
  const mainImage   = document.getElementById("mainImage");
  const markerLayer = document.getElementById("markerLayer");
  const thumbs      = document.querySelectorAll(".thumb-img");
  const annotateBtn = document.getElementById("annotateBtn");

    function renderMarkers(imageId) {
      if (!markerLayer) return;
      markerLayer.innerHTML = "";
      if (!imageId) return;

      const arr = markersByImage[imageId] || [];
      arr.forEach(m => {
        const dot = document.createElement("div");
        dot.className = "marker-dot";
        const color = m.color || "#ff4d4f";           // üî¥ –±–µ—Ä–µ–º–æ –∫–æ–ª—ñ—Ä –∑ –ë–î
        dot.style.left = m.x + "%";
        dot.style.top  = m.y + "%";
        dot.style.borderColor = color;
        dot.style.backgroundColor = color + "33";     // –ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω —Ç–æ–≥–æ —Å–∞–º–æ–≥–æ –∫–æ–ª—å–æ—Ä—É
        dot.dataset.label = m.item || "";
        markerLayer.appendChild(dot);
      });
    }

  if (thumbs.length && mainImage) {
    thumbs.forEach(t => {
      t.addEventListener("click", () => {
        thumbs.forEach(x => x.classList.remove("active"));
        t.classList.add("active");

        mainImage.src = t.dataset.full;
        mainImage.dataset.imageId = t.dataset.imageId || "";

        if (annotateBtn && t.dataset.imageId) {
          annotateBtn.href = "{% url 'annotate_order_image' 0 %}"
            .replace("/0/", `/${t.dataset.imageId}/`);
        }

        renderMarkers(mainImage.dataset.imageId);
      });
    });

    renderMarkers(mainImage.dataset.imageId || "");
  }

  const categoryToggles = document.querySelectorAll(".category-toggle-btn, .category-header");
  categoryToggles.forEach(el => {
    el.addEventListener("click", () => {
      const targetId = el.getAttribute("data-target");
      if (!targetId) return;
      const body = document.getElementById(targetId);
      if (!body) return;

      const btn = document.querySelector(`.category-toggle-btn[data-target="${targetId}"]`);
      if (!btn) return;

      const textSpan = btn.querySelector(".text");

      body.classList.toggle("collapsed");
      btn.classList.toggle("collapsed");

      if (body.classList.contains("collapsed")) {
        if (textSpan) textSpan.textContent = "–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏";
      } else {
        if (textSpan) textSpan.textContent = "–ó–≥–æ—Ä–Ω—É—Ç–∏";
      }
    });
  });

  const select    = document.getElementById("existingCustomerSelect");
  const newFields = document.getElementById("newCustomerFields");
  const saveBtn   = document.getElementById("saveNewCustomerBtn");

  if (select && newFields && saveBtn) {
    select.addEventListener("change", () => {
      if (select.value === "") {
        newFields.style.display = "flex";
        saveBtn.style.display   = "block";
      } else {
        newFields.style.display = "none";
        saveBtn.style.display   = "none";
      }
    });
  }
});

// üîç –ó—É–º + –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è (—Ä—É—Ö–∞—î–º–æ –≤–µ—Å—å mainImageInner —Ä–∞–∑–æ–º –∑ –º—ñ—Ç–∫–∞–º–∏)
(function () {
  const wrapper = document.getElementById("mainImageWrapper");
  const inner   = document.getElementById("mainImageInner");
  if (!wrapper || !inner) return;

  let scale = 1;
  const MIN_SCALE = 1;
  const MAX_SCALE = 4;
  let posX = 0;
  let posY = 0;

  let isDragging = false;
  let dragStartX = 0;
  let dragStartY = 0;

  function updateTransform() {
    inner.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
  }

  wrapper.addEventListener('wheel', (e) => {
    e.preventDefault();

    const delta = e.deltaY < 0 ? 0.15 : -0.15;
    const prevScale = scale;
    scale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, scale + delta));

    const rect = wrapper.getBoundingClientRect();
    const offsetX = e.clientX - rect.left;
    const offsetY = e.clientY - rect.top;

    const dx = offsetX - rect.width / 2;
    const dy = offsetY - rect.height / 2;

    const scaleRatio = scale / prevScale;

    posX = posX * scaleRatio + dx * (scaleRatio - 1);
    posY = posY * scaleRatio + dy * (scaleRatio - 1);

    if (scale === MIN_SCALE) {
      posX = 0;
      posY = 0;
    }

    updateTransform();
  }, { passive: false });

  wrapper.addEventListener('mousedown', (e) => {
    if (scale === MIN_SCALE) return;
    isDragging = true;
    wrapper.classList.add('dragging');
    dragStartX = e.clientX - posX;
    dragStartY = e.clientY - posY;
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    posX = e.clientX - dragStartX;
    posY = e.clientY - dragStartY;
    updateTransform();
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    wrapper.classList.remove('dragging');
  });

  wrapper.addEventListener('touchstart', (e) => {
    if (scale === MIN_SCALE) return;
    const touch = e.touches[0];
    isDragging = true;
    wrapper.classList.add('dragging');
    dragStartX = touch.clientX - posX;
    dragStartY = touch.clientY - posY;
  }, { passive: true });

  wrapper.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    const touch = e.touches[0];
    posX = touch.clientX - dragStartX;
    posY = touch.clientY - dragStartY;
    updateTransform();
  }, { passive: true });

  wrapper.addEventListener('touchend', () => {
    isDragging = false;
    wrapper.classList.remove('dragging');
  });
})();
</script>
{% endblock %}
