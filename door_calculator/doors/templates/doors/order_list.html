{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
  <h2 class="fw-bold mb-4 text-center">üìã –°–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å</h2>

  <!-- üîπ –§–æ—Ä–º–∞ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ -->
  <form method="get" class="card p-3 shadow-sm mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-bold">–ó –¥–∞—Ç–∏</label>
        <input type="date"
               name="start_date"
               class="form-control"
               value="{{ request.GET.start_date }}">
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">–ü–æ –¥–∞—Ç—É</label>
        <input type="date"
               name="end_date"
               class="form-control"
               value="{{ request.GET.end_date }}">
      </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">–¢–∏–ø –ø—Ä–æ—î–∫—Ç—É</label>
          <select name="work_type" class="form-select">
            <option value="">–£—Å—ñ</option>
            {% for key, label in work_type_choices %}
              <option value="{{ key }}"
                      {% if request.GET.work_type == key %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">–°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
        <select name="status" class="form-select">
          <option value="">–£—Å—ñ</option>
          {% for key, label in status_choices %}
            <option value="{{ key }}"
                    {% if request.GET.status == key %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% if request.user.is_superuser %}
      <div class="col-md-3">
        <label class="form-label fw-bold">–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å</label>
        <select name="status_finance" class="form-select">
          <option value="">–£—Å—ñ</option>
          {% for key, label in status_finance_choices %}
            <option value="{{ key }}"
                    {% if request.GET.status_finance == key %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>
      {% else %}
      <div class="col-md-3 d-flex justify-content-end mt-3 mt-md-0">
        <!-- –ø—Ä–æ—Å—Ç–æ —â–æ–± –∫–Ω–æ–ø–∫–∞ –Ω–µ –∑'—ó–∂–¥–∂–∞–ª–∞, —è–∫—â–æ —Ñ—ñ–Ω—É —Å—Ç–∞—Ç—É—Å –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ -->
      </div>
      {% endif %}

    {# üîπ –ü–æ—à—É–∫ –ø–æ –Ω–∞–∑–≤—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #}
    <div class="col-md-4 mt-3">
      <label class="form-label fw-bold">–ù–∞–∑–≤–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>

      <div class="input-group">
        <input type="text"
               name="order_name"
               class="form-control"
               placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏‚Ä¶"
               list="orderNameList"
               value="{{ request.GET.order_name|default:'' }}">
        <button class="btn btn-outline-secondary" type="submit">üîç</button>
      </div>
      <datalist id="orderNameList">
        {% for name in order_name_choices %}
          <option value="{{ name }}"></option>
        {% endfor %}
      </datalist>
    </div>


      <div class="col-md-2 ms-auto text-end mt-3">
        <button type="submit" class="btn btn-primary w-100">
          üîç –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏
        </button>
      </div>
    </div>
  </form>

  {% if orders %}
  <div class="table-responsive shadow-sm">
    <table class="table table-hover align-middle">
      <thead class="table-primary text-center">
        <tr>
          <th>‚Ññ</th>
          <th>–ù–∞–∑–≤–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</th> {# NEW #}
          <th>–î–∞—Ç–∞</th>
          <th>–ü–æ–∑–∏—Ü—ñ–π</th>
          <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫\—Å</th>
          <th>–í–∞—Ä—Ç—ñ—Å—Ç—å</th>
          {% if request.user.is_superuser %}
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å</th>
          {% endif %}

          <th>–í–∏–∫–æ–Ω–∞–Ω–Ω—è</th>

          {% if request.user.is_superuser %}
            <th>–î—ñ—ó</th>
          {% else %}
            <th>–ü–µ—Ä–µ–≥–ª—è–¥</th>
          {% endif %}
        </tr>
      </thead>

      <tbody class="text-center">
        {% for order in orders %}

        <tr class="{% if order.status == 'completed' %}table-success{% elif order.status == 'postponed' %}table-warning{% endif %}">
          <td><strong>{{ order.order_number }}</strong></td>

          {# üîπ –ù–∞–∑–≤–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (NEW) #}
          <td>
            {% if order.order_name %}
              {{ order.order_name }}
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>

          <td>{{ order.created_at|date:"d.m.Y" }}</td>
          <td>{{ order.items.count }}</td>
          <td>{{ order.total_ks }}</td>
          <td>{{ order.total_cost|floatformat:2 }} –≥—Ä–Ω</td>

          {% if request.user.is_superuser %}
            <!-- –°—Ç–∞—Ç—É—Å (—Å—É–ø–µ—Ä—é–∑–µ—Ä) -->
            <td>
              <select class="form-select form-select-sm status-select"
                      data-id="{{ order.id }}"
                      data-kind="status">
                {% for key, label in order.STATUS_CHOICES %}
                  <option value="{{ key }}" {% if key == order.status %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </td>

            <!-- –§—ñ–Ω–∞–Ω—Å–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å (—Å—É–ø–µ—Ä—é–∑–µ—Ä) -->
            <td>
              <select class="form-select form-select-sm status-select"
                      data-id="{{ order.id }}"
                      data-kind="status_finance">
                {% for key, label in order.STATUS_CHOICES_FINANCE %}
                  <option value="{{ key }}" {% if key == order.status_finance %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </td>
          {% endif %}

          <!-- –í—ñ–¥—Å–æ—Ç–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è -->
          <td style="width:180px;">
            <div class="progress" style="height: 22px;">
              <div class="progress-bar
                  {% if order.completion_percent >= 100 %}bg-success
                  {% elif order.completion_percent >= 50 %}bg-info
                  {% else %}bg-warning{% endif %}"
                   role="progressbar"
                   style="width: {{ order.completion_percent }}%;"
                   aria-valuenow="{{ order.completion_percent }}"
                   aria-valuemin="0" aria-valuemax="100">
                {{ order.completion_percent }}%
              </div>
            </div>
          </td>

          {% if request.user.is_superuser %}
            <!-- –î—ñ—ó (—Å—É–ø–µ—Ä—é–∑–µ—Ä) -->
            <td>
              <a href="{% url 'calculate_order' order.id %}"
                 class="btn btn-sm btn-success"
                 title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                üîß
              </a>

              <a href="{% url 'generate_pdf' order.id %}"
                 class="btn btn-sm btn-outline-primary"
                 target="_blank"
                 title="PDF">
                üìÑ
              </a>

              <button type="button"
                      class="btn btn-sm btn-danger ms-1 delete-order-btn"
                      data-url="{% url 'order_delete' order.id %}"
                      title="–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è">
                üóëÔ∏è
              </button>
            </td>
          {% else %}
            <!-- –ü–µ—Ä–µ–≥–ª—è–¥ (–∑–≤–∏—á–∞–π–Ω–∏–π —é–∑–µ—Ä) -->
            <td>
              <a href="{% url 'calculate_order' order.id %}"
                 class="btn btn-sm btn-outline-primary"
                 title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">
                üëÅÔ∏è
              </a>
            </td>
          {% endif %}
        </tr>

        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
    <div class="alert alert-info text-center mt-4">
      –ù–µ–º–∞—î —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å.
    </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ‚úÖ –°—Ç–∞—Ç—É—Å–∏ –æ–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç–∏ —î (—Ç–æ–±—Ç–æ —Å—É–ø–µ—Ä—é–∑–µ—Ä)
  document.querySelectorAll(".status-select").forEach(select => {
    select.addEventListener("change", async (e) => {
      const id = e.target.dataset.id;
      const value = e.target.value;
      const kind = e.target.dataset.kind || "status";

      const resp = await fetch(`/update-status/${id}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ kind: kind, value: value })
      });

      if (resp.ok) {
        e.target.classList.add("border-success");
        setTimeout(() => e.target.classList.remove("border-success"), 800);
      } else {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É.");
      }
    });
  });

  // ‚úÖ –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (—Ç—ñ–ª—å–∫–∏ —Å—É–ø–µ—Ä—é–∑–µ—Ä ‚Äî –∫–Ω–æ–ø–∫–∞ —ñ—Å–Ω—É—î –ª–∏—à–µ –≤ –Ω—å–æ–≥–æ)
  document.querySelectorAll(".delete-order-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!confirm("–î—ñ–π—Å–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?")) return;

      const url = btn.dataset.url;

      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        }
      });

      if (resp.ok) {
        const row = btn.closest("tr");
        if (row) row.remove();
      } else {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
      }
    });
  });
});
</script>
{% endblock %}
