{% extends 'base.html' %}
{% block content %}
<div class="container py-5">
    <h3 class="mb-4 text-center">üìà –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>

    <!-- üîπ –§–æ—Ä–º–∞ –≤–∏–±–æ—Ä—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (GET) -->
    <form method="get" class="mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <label class="form-label fw-bold">–û–±–µ—Ä—ñ—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
          <select name="order"
                  class="form-select"
                  onchange="this.form.submit()">
            <option value="">‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî</option>
            {% for o in all_orders %}
              <option value="{{ o.id }}"
                      {% if selected_order and o.id == selected_order.id %}selected{% endif %}>
                ‚Ññ{{ o.order_number }} {{o.order_name }} –≤—ñ–¥ {{ o.created_at|date:"d.m.Y" }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </form>
    <!-- üîπ –§–æ—Ä–º–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É (POST) -->
    {% if selected_order %}
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="order_id" value="{{ selected_order.id }}">

      <div class="card mb-4">
        <div class="card-body">
          <h5 class="mb-3">
            –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ{{ selected_order.order_number }}
            –Ω–∞–∑–≤–∞ {{selected_order.order_name }}
            –≤—ñ–¥ {{ selected_order.created_at|date:"d.m.Y" }}
          </h5>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">–í–∏–∫–æ–Ω–∞–Ω–æ (%)</label>
              {{ form.percent }}
            </div>

            <div class="col-md-8">
              <label class="form-label fw-bold">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
              {{ form.comment }}
            </div>
          </div>

          <!-- –ü–æ–∑–∏—Ü—ñ—ó, —è–∫—ñ –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ -->
          <div class="mt-3">
            <label class="form-label fw-bold">
              –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó, —è–∫—ñ –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏
            </label>
            <small class="text-muted d-block mb-2">
              –ú–æ–∂–Ω–∞ –æ–±—Ä–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π. –ù–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ –ø—Ä–æ—Å—Ç–æ —Ç–∏–∫–∞–π—Ç–µ –ø–æ –Ω–∞–∑–≤—ñ.
            </small>

            {% if order_items_for_selection %}
              <div class="row">
                {% for it in order_items_for_selection %}
                  <div class="col-12 col-md-6 mb-1">
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             name="problem_items"
                             value="{{ it.id }}"
                             id="problem_item_{{ it.id }}">
                      <label class="form-check-label w-100"
                             for="problem_item_{{ it.id }}">
                        {{ it.name }}
                      </label>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted">–£ —Ü—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —â–µ –Ω–µ–º–∞—î –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π.</p>
            {% endif %}
          </div>

          <div class="text-end mt-3">
            <button type="submit" class="btn btn-success">
              üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
            </button>
          </div>
        </div>
      </div>
    </form>
    {% else %}
      <p class="text-muted">
        –°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏—â–µ, —â–æ–± –≤–≤–µ—Å—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å —Ç–∞ –ø–æ–∑–Ω–∞—á–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ñ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó.
      </p>
    {% endif %}
  </div>

  <h4 class="fw-bold mb-3">üïí –û—Å—Ç–∞–Ω–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</h4>
  <table class="table table-striped align-middle shadow-sm">
    <thead class="table-primary">
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>‚Ññ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
        <th>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
        <th>–í–∏–∫–æ–Ω–∞–Ω–æ (%)</th>
        <th>–ü—Ä–æ–±–ª–µ–º–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó</th>
        <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
      </tr>
    </thead>
    <tbody>
      {% for p in latest_progress %}
      <tr>
        <td>{{ p.date|date:"d.m.Y" }}</td>
        <td>‚Ññ{{ p.order.order_number }}</td>
        <td>{{ p.order.order_name }}</td>
        <td>{{ p.percent }}%</td>
        <td>
          {% with items=p.problem_items.all %}
            {% if items %}
              {% for it in items %}
                <span class="badge bg-danger-subtle text-danger border border-danger-subtle mb-1">
                  {{ it.name }}
                </span><br>
              {% endfor %}
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          {% endwith %}
        </td>
        <td>{{ p.comment }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

