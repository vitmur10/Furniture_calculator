{% extends 'base.html' %}
{% block content %}

<style>
    .annotate-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

  .action-row{
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  margin-bottom: 10px;
    }
    .action-row .btn{
      white-space: nowrap;
    }

    @media (max-width: 768px){
      .action-row{
        flex-direction: column;
        align-items: stretch;
      }
      .action-row .btn{
        width: 100%;
      }
    }
    .image-panel {
      flex: 1 1 auto;
      max-width: 680px;
    }

  .image-wrapper {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    background: #111;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 18px rgba(0,0,0,0.3);
  }

  .image-wrapper img {
    width: 100%;
    height: auto;
    max-height: 520px;
    object-fit: contain;
    display: block;
  }

  .marker-layer {
    position: absolute;
    inset: 0;
    pointer-events: none; /* –∫–ª—ñ–∫–∏ –π–¥—É—Ç—å –ø–æ —Å–∞–º–æ–º—É img */
  }

  .marker-dot {
    position: absolute;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid #fff;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 4px rgba(0,0,0,0.6);
    cursor: pointer;
    pointer-events: auto;
  }

  .marker-dot:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .marker-dot::after {
    content: attr(data-label);
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    color: #fff;
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 4px;
    white-space: nowrap;
  }

    .info-panel {
      flex: 0 0 360px;
      position: sticky;
      top: 20px; /* –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–∂–¥–∏ –≤–∏–¥–Ω–æ */
    }

  .markers-list {
    max-height: 360px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 8px;
    background: #fff;
  }

  .marker-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 6px;
    border-radius: 6px;
    margin-bottom: 4px;
    font-size: 13px;
  }

  .marker-item:nth-child(odd) {
    background: #f8f9fa;
  }

  .color-pill {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 1px solid #ccc;
  }

  .marker-remove-btn {
    margin-left: auto;
    border: none;
    background: transparent;
    color: #dc3545;
    font-size: 16px;
    line-height: 1;
    cursor: pointer;
  }

  .hint-box {
    font-size: 13px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 8px 10px;
    margin-top: 8px;
  }
</style>

<div class="container py-4">
  <h3 class="mb-3">
    üñäÔ∏è –†–æ–∑–º—ñ—Ç–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ{{ order.order_number }}
  </h3>

  <a href="{% url 'calculate_order' order.id %}" class="btn btn-sm btn-outline-secondary mb-3">
    ‚Üê –î–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
  </a>

  <div class="annotate-layout">
    <!-- üñº –õ–Ü–í–ê –ü–ê–ù–ï–õ–¨: –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø -->
    <div class="image-panel">
      <div class="image-wrapper" id="imageWrapper">
        <img src="{{ image_url }}"
             alt="–§–æ—Ç–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
             id="annotImg">
        <div class="marker-layer" id="markerLayer"></div>
      </div>
      <div class="hint-box mt-2">
        1Ô∏è‚É£ –û–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é.<br>
        2Ô∏è‚É£ –í–∏–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä –º—ñ—Ç–∫–∏.<br>
        3Ô∏è‚É£ –ö–ª—ñ–∫ –ø–æ —Ñ–æ—Ç–æ ‚Äî –¥–æ–¥–∞—Å—Ç—å –º—ñ—Ç–∫—É –¥–ª—è —Ü—ñ—î—ó –ø–æ–∑–∏—Ü—ñ—ó.<br>
        4Ô∏è‚É£ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–º—ñ–Ω–∏—Ç—å —É—Å—ñ –º—ñ—Ç–∫–∏ –¥–ª—è —Ü—å–æ–≥–æ —Ñ–æ—Ç–æ.
      </div>
    </div>

    <!-- üìã –ü–†–ê–í–ê –ü–ê–ù–ï–õ–¨: –§–û–†–ú–ê -->
    <div class="info-panel">
      <form method="post" id="markersForm">
        {% csrf_token %}
        <input type="hidden" id="markersJson" name="markers_json" value="[]"

        <div class="mb-3">
          <label class="form-label fw-bold">–ü–æ–∑–∏—Ü—ñ—è (–≤–∏—Ä—ñ–±)</label>
          <select class="form-select" id="itemSelect">
            <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é ‚Äî</option>
            {% for it in items %}
              <option value="{{ it.id }}">{{ it.name }} (ID: {{ it.id }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">–ö–æ–ª—ñ—Ä –º—ñ—Ç–æ–∫</label>
          <div class="d-flex align-items-center gap-2">
            <input type="color" id="colorPicker" value="#FF0000" class="form-control form-control-color" title="–û–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä">
            <select id="colorPreset" class="form-select form-select-sm" style="max-width: 180px;">
              <option value="">‚Äî –ü–∞–ª—ñ—Ç—Ä–∞ ‚Äî</option>
              <option value="#e6194b">–ß–µ—Ä–≤–æ–Ω–∏–π</option>
              <option value="#3cb44b">–ó–µ–ª–µ–Ω–∏–π</option>
              <option value="#0082c8">–°–∏–Ω—ñ–π</option>
              <option value="#f58231">–ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π</option>
              <option value="#911eb4">–§—ñ–æ–ª–µ—Ç–æ–≤–∏–π</option>
              <option value="#46f0f0">–ë—ñ—Ä—é–∑–æ–≤–∏–π</option>
              <option value="#f032e6">–†–æ–∂–µ–≤–∏–π</option>
              <option value="#008080">–¢—ñ–ª</option>
              <option value="#ffe119">–ñ–æ–≤—Ç–∏–π</option>
              <option value="#800000">–ë–æ—Ä–¥–æ–≤–∏–π</option>
              <option value="#9a6324">–ö–æ—Ä–∏—á–Ω–µ–≤–∏–π</option>
              <option value="#469990">–ú'—è—Ç–Ω–∏–π</option>
              <option value="#000075">–¢–µ–º–Ω–æ-—Å–∏–Ω—ñ–π</option>
              <option value="#bfef45">–õ–∞–π–º</option>
              <option value="#fabed4">–°–≤—ñ—Ç–ª–æ-—Ä–æ–∂–µ–≤–∏–π</option>
              <option value="#dcbeff">–°–≤—ñ—Ç–ª–æ-—Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π</option>
              <option value="#aaffc3">–°–≤—ñ—Ç–ª–æ-–∑–µ–ª–µ–Ω–∏–π</option>
              <option value="#ffd8b1">–ü–µ—Ä—Å–∏–∫–æ–≤–∏–π</option>
              <option value="#808000">–û–ª–∏–≤–∫–æ–≤–∏–π</option>
              <option value="#000000">–ß–æ—Ä–Ω–∏–π</option>
            </select>
          </div>
        </div>

      <div class="action-row">
        <button type="button" class="btn btn-sm btn-outline-danger" id="resetCurrentItemBtn">
          üßπ –°–∫–∏–Ω—É—Ç–∏ –º—ñ—Ç–∫–∏ –¥–ª—è –ø–æ–∑–∏—Ü—ñ—ó
        </button>

        <button type="submit" class="btn btn-sm btn-primary" id="saveMarkersBtn">
          üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –º—ñ—Ç–∫–∏
        </button>
      </div>

        <div class="mt-3">
          <h6 class="fw-bold">–ú—ñ—Ç–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ:</h6>
          <div class="markers-list" id="markersList"></div>
        </div>
      </form>
    </div>
  </div>
</div>
{{ markers|json_script:"initial-markers" }}

{# ===== JS: –ø–æ—á–∞—Ç–∫–æ–≤—ñ –º—ñ—Ç–∫–∏ –∑ –±–µ–∫–µ–Ω–¥—É ===== #}
<script>
const initialMarkers = JSON.parse(
  document.getElementById("initial-markers").textContent
);
let allMarkers = Array.isArray(initialMarkers) ? [...initialMarkers] : [];
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const img = document.getElementById("annotImg");
  const wrapper = document.getElementById("imageWrapper");
  const markerLayer = document.getElementById("markerLayer");
  const itemSelect = document.getElementById("itemSelect");
  const colorPicker = document.getElementById("colorPicker");
  const colorPreset = document.getElementById("colorPreset");
  const resetCurrentItemBtn = document.getElementById("resetCurrentItemBtn");
  const markersList = document.getElementById("markersList");
  const markersJson = document.getElementById("markersJson");
  const form = document.getElementById("markersForm");

  // —É—Å—ñ –º—ñ—Ç–∫–∏ —Ü—å–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    let allMarkers = Array.isArray(initialMarkers) ? [...initialMarkers] : [];

  // –ø–æ—Ç–æ—á–Ω–∞ –ø–æ–∑–∏—Ü—ñ—è —Ç–∞ –∫–æ–ª—ñ—Ä
  let currentItemId = "";
  let currentItemName = "";
  let currentColor = colorPicker.value;

  // –Ø–∫—â–æ —Ö–æ—á–µ–º–æ –∞–≤—Ç–æ-–∫–æ–ª—ñ—Ä –¥–ª—è –∫–æ–∂–Ω–æ—ó –ø–æ–∑–∏—Ü—ñ—ó ‚Äî –ø—Ä–æ—Å—Ç–∞ –ø–∞–ª—ñ—Ç—Ä–∞
  const palette = [
    "#e6194b","#3cb44b","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6","#008080",
    "#ffe119","#800000","#9a6324","#469990","#000075","#bfef45","#fabed4","#dcbeff",
    "#aaffc3","#ffd8b1","#808000","#000000","#82b7ff","#ff6eb4","#7fef6f","#ff9f40",
    "#8f4bff","#00c9a7","#ff4d4f","#ffcc00","#00bcd4","#673ab7"
  ];
  const itemColorMap = {};

  function getColorForItem(itemId) {
    if (!itemId) return currentColor;
    if (itemColorMap[itemId]) return itemColorMap[itemId];

    const existing = allMarkers.find(m => String(m.item_id) === String(itemId) && m.color);
    if (existing) {
      itemColorMap[itemId] = existing.color;
      return existing.color;
    }
    const idx = Object.keys(itemColorMap).length % palette.length;
    const c = palette[idx];
    itemColorMap[itemId] = c;
    return c;
  }

  // –∫–æ–ª–∏ –º—ñ–Ω—è—î–º–æ –ø–æ–∑–∏—Ü—ñ—é
  itemSelect.addEventListener("change", () => {
    currentItemId = itemSelect.value;
    currentItemName = itemSelect.options[itemSelect.selectedIndex]?.text || "";

    if (currentItemId) {
      const autoColor = getColorForItem(currentItemId);
      currentColor = autoColor;
      colorPicker.value = autoColor;
    }
  });

  // –∫–æ–ª—ñ—Ä –∑ color input
  colorPicker.addEventListener("input", () => {
    currentColor = colorPicker.value;
    if (currentItemId) {
      itemColorMap[currentItemId] = currentColor;
    }
    renderMarkers();
  });

  // –≤–∏–±—ñ—Ä –∑ –ø—Ä–µ—Å–µ—Ç—ñ–≤
  colorPreset.addEventListener("change", () => {
    if (!colorPreset.value) return;
    currentColor = colorPreset.value;
    colorPicker.value = currentColor;
    if (currentItemId) {
      itemColorMap[currentItemId] = currentColor;
    }
    renderMarkers();
  });

  // –∫–ª—ñ–∫ –ø–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—é -> –¥–æ–¥–∞—î–º–æ –º—ñ—Ç–∫—É
  wrapper.addEventListener("click", (e) => {
    if (e.target !== img) return;  // —â–æ–± –Ω–µ –ª–æ–≤–∏—Ç–∏ –∫–ª—ñ–∫–∏ –ø–æ –º—ñ—Ç–∫–∞—Ö
    if (!currentItemId) {
      alert("–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é.");
      return;
    }

    const rect = img.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    const marker = {
      id: null,
      x: x,
      y: y,
      item_id: parseInt(currentItemId),
      item_name: currentItemName || ("–ü–æ–∑–∏—Ü—ñ—è #" + currentItemId),
      color: currentColor || "#FF0000"
    };
    allMarkers.push(marker);
    renderMarkers();
  });

  // —Å–∫–∏–Ω—É—Ç–∏ –º—ñ—Ç–∫–∏ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
  resetCurrentItemBtn.addEventListener("click", () => {
    if (!currentItemId) {
      alert("–û–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é, –¥–ª—è —è–∫–æ—ó —Ç—Ä–µ–±–∞ —Å–∫–∏–Ω—É—Ç–∏ –º—ñ—Ç–∫–∏.");
      return;
    }
    if (!confirm("–°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ –º—ñ—Ç–∫–∏ –¥–ª—è —Ü—ñ—î—ó –ø–æ–∑–∏—Ü—ñ—ó?")) return;
    allMarkers = allMarkers.filter(m => String(m.item_id) !== String(currentItemId));
    renderMarkers();
  });

  // –≤–∏–¥–∞–ª–µ–Ω–Ω—è –æ–¥–Ω—ñ—î—ó –º—ñ—Ç–∫–∏
  function deleteMarkerByIndex(idx) {
    allMarkers.splice(idx, 1);
    renderMarkers();
  }

  // –≤—ñ–¥–º–∞–ª—å–æ–≤—É—î–º–æ –º—ñ—Ç–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ + –≤ —Å–ø–∏—Å–∫—É
  function renderMarkers() {
    // —à–∞—Ä –Ω–∞ —Ñ–æ—Ç–æ
    markerLayer.innerHTML = "";
    allMarkers.forEach((m, index) => {
      const dot = document.createElement("div");
      dot.className = "marker-dot";
      dot.style.left = m.x + "%";
      dot.style.top = m.y + "%";
      dot.style.backgroundColor = m.color || "#FF0000";
      dot.dataset.label = m.item_name || "";
      markerLayer.appendChild(dot);

      // –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∫–ª—ñ–∫ –ø–æ —Ç–æ—á—Ü—ñ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
      dot.addEventListener("click", (e) => {
        e.stopPropagation();
        if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –º—ñ—Ç–∫—É?")) {
          deleteMarkerByIndex(index);
        }
      });
    });

    // —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤–æ—Ä—É—á
    markersList.innerHTML = "";
    if (!allMarkers.length) {
      markersList.innerHTML = "<div class='text-muted small'>–ú—ñ—Ç–æ–∫ —â–µ –Ω–µ–º–∞—î.</div>";
      return;
    }

    allMarkers.forEach((m, index) => {
      const row = document.createElement("div");
      row.className = "marker-item";

      const pill = document.createElement("div");
      pill.className = "color-pill";
      pill.style.backgroundColor = m.color || "#FF0000";

      const label = document.createElement("div");
      label.innerHTML =
        `<strong>${m.item_name || "–ë–µ–∑ –ø–æ–∑–∏—Ü—ñ—ó"}</strong> &nbsp; ` +
        `<span class="text-muted">(${m.x.toFixed(1)}%, ${m.y.toFixed(1)}%)</span>`;

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "marker-remove-btn";
      delBtn.innerHTML = "&times;";
      delBtn.addEventListener("click", () => {
        if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –º—ñ—Ç–∫—É?")) {
          deleteMarkerByIndex(index);
        }
      });

      row.appendChild(pill);
      row.appendChild(label);
      row.appendChild(delBtn);
      markersList.appendChild(row);
    });
  }

  // –ø—Ä–∏ —Å–∞–±–º—ñ—Ç—ñ —Ñ–æ—Ä–º–∏ —Å–µ—Ä—ñ–∞–ª—ñ–∑—É—î–º–æ –≤—Å—ñ –º—ñ—Ç–∫–∏
form.addEventListener("submit", (e) => {
  const payload = allMarkers.map(m => ({
    x: m.x,
    y: m.y,
    item_id: m.item_id,
    color: m.color
  }));

  markersJson.value = JSON.stringify(payload);

  console.log("SUBMIT payload:", payload);
  console.log("hidden markersJson.value:", markersJson.value);
});

  // —Å—Ç–∞—Ä—Ç–æ–≤–∏–π —Ä–µ–Ω–¥–µ—Ä
  renderMarkers();
});

</script>

{% endblock %}
